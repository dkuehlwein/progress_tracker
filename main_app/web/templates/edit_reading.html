{% extends "base.html" %}

{% block title %}Edit "{{ entry.title }}" - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div>
            <div class="card-header-with-back">
                <a href="/web/reading" class="back-link" aria-label="Back to reading entries">&larr;</a>
                <h2 class="card-title"><span aria-hidden="true">âœï¸</span> Edit Reading Entry</h2>
            </div>
            <p class="text-muted" style="margin:var(--sp-2) 0 0 0">
                <strong>{{ entry.title }}</strong>{% if entry.author %} by {{ entry.author }}{% endif %}
            </p>
        </div>
        <div class="entry-meta">
            <span class="status-badge status-{{ entry.status.value if entry.status else 'pending' }}">
                {{ entry.status.value.replace('_', ' ').title() if entry.status else 'Pending' }}
            </span>
            {% if entry.progress_fraction %}
            <div class="table-progress" style="width:80px;margin-top:var(--sp-2)">
                <div class="table-progress-bar" style="width:{{ (entry.progress_fraction * 100)|round }}%"></div>
            </div>
            <small class="text-muted">{{ (entry.progress_fraction * 100)|round }}%</small>
            {% endif %}
        </div>
    </div>
</div>

<div class="card">
    <form action="/web/reading/edit/{{ entry.id }}" method="POST" id="editForm">
        {% include "reading_form_partial.html" %}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary" id="saveBtn">
                <span aria-hidden="true">ğŸ’¾</span> Save Changes
            </button>
            <a href="/web/reading" class="btn btn-secondary">Cancel</a>
            <button type="button" class="btn btn-delete btn-sm" onclick="confirmDelete()" aria-label="Delete this entry">
                <span aria-hidden="true">ğŸ—‘ï¸</span> Delete
            </button>
        </div>
    </form>
</div>

<script>
function confirmDelete() {
    if (confirm('Are you sure you want to delete "{{ entry.title }}"? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/web/reading/delete/{{ entry.id }}';
        document.body.appendChild(form);
        form.submit();
    }
}

const form = document.getElementById('editForm');
const saveBtn = document.getElementById('saveBtn');
let hasUnsavedChanges = false;

form.addEventListener('input', () => {
    hasUnsavedChanges = true;
    saveBtn.classList.add('btn-warning');
    saveBtn.classList.remove('btn-primary');
});

form.addEventListener('submit', () => {
    hasUnsavedChanges = false;
    saveBtn.disabled = true;
    try { localStorage.removeItem('reading_edit_draft_{{ entry.id }}'); } catch (_) {}
});

window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
    }
});

const progressInput = document.querySelector('#progress_fraction');
if (progressInput) {
    progressInput.addEventListener('input', (e) => {
        const value = parseFloat(e.target.value);
        if (value >= 0 && value <= 1) {
            e.target.title = Math.round(value * 100) + '% complete';
        }
    });
}
</script>
{% endblock %}
