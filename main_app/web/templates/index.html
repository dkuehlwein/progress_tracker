{% extends "base.html" %}

{% block content %}
{% if not users %}
<div class="alert alert-info" style="margin-bottom: var(--spacing-lg);">
    <span>ℹ️</span>
    <span>No users found. Create users via the API first.</span>
</div>
{% endif %}

{% if selected_user %}
<!-- User-specific dashboard -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <span style="font-size: 3rem;">
                {% if selected_user.name == "simon" %}🧒{% else %}👨{% endif %}
            </span>
            <div>
                <h2 style="margin: 0;">{{ selected_user.display_name }}'s Dashboard</h2>
                <p style="margin: 0; color: #6c757d;">
                    {% if selected_user.name == "simon" %}
                        Reading & Drawing Progress
                    {% else %}
                        Fitness & Health Tracking
                    {% endif %}
                </p>
            </div>
        </div>
        <a href="/web" style="text-decoration: none; color: #667eea;">← All Users</a>
    </div>
    
    <!-- Quick Actions for Selected User -->
    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
        {% if selected_user.name == "simon" %}
        <a href="/web/reading/add?user_id={{ selected_user.id }}" class="btn btn-primary" style="text-decoration: none; flex: 1; min-width: 120px; text-align: center;">📚 Add Book</a>
        <a href="/web/drawing/add?user_id={{ selected_user.id }}" class="btn btn-primary" style="text-decoration: none; flex: 1; min-width: 120px; text-align: center;">🎨 Add Art</a>
        <a href="/web/journal/add?user_id={{ selected_user.id }}" class="btn btn-primary" style="text-decoration: none; flex: 1; min-width: 120px; text-align: center;">📝 Add Journal</a>
        {% else %}
        <a href="/web/fitness/add?user_id={{ selected_user.id }}" class="btn btn-primary" style="text-decoration: none; flex: 1; min-width: 120px; text-align: center;">💪 Add Workout</a>
        <a href="/web/reading/add?user_id={{ selected_user.id }}" class="btn btn-primary" style="text-decoration: none; flex: 1; min-width: 120px; text-align: center;">📚 Add Book</a>
        <a href="/web/journal/add?user_id={{ selected_user.id }}" class="btn btn-primary" style="text-decoration: none; flex: 1; min-width: 120px; text-align: center;">📝 Add Journal</a>
        {% endif %}
    </div>
</div>

<!-- Monthly Stats -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <h3>📊 This Month's Progress</h3>
    
    {% if selected_user.name == "simon" %}
    <div class="two-column">
        <div style="text-align: center; padding: 1rem; background: #f8f9ff; border-radius: 8px;">
            <div style="font-size: 2rem; color: #667eea; font-weight: bold;">{{ monthly_stats.reading_count }}</div>
            <div style="color: #6c757d;">Books Started</div>
            <div style="font-size: 0.9rem; color: #28a745;">{{ monthly_stats.reading_completed }} completed</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #fff5f5; border-radius: 8px;">
            <div style="font-size: 2rem; color: #e74c3c; font-weight: bold;">{{ monthly_stats.drawing_count }}</div>
            <div style="color: #6c757d;">Art Projects</div>
            <div style="font-size: 0.9rem; color: #28a745;">{{ monthly_stats.total_drawing_hours | round(1) }}h total</div>
        </div>
    </div>
    {% else %}
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
        <div style="text-align: center; padding: 1rem; background: #f0fff4; border-radius: 8px;">
            <div style="font-size: 2rem; color: #28a745; font-weight: bold;">{{ monthly_stats.fitness_count }}</div>
            <div style="color: #6c757d;">Activities</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #f8f9ff; border-radius: 8px;">
            <div style="font-size: 2rem; color: #667eea; font-weight: bold;">{{ (monthly_stats.total_minutes / 60) | round(1) }}</div>
            <div style="color: #6c757d;">Hours</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #fff5f5; border-radius: 8px;">
            <div style="font-size: 2rem; color: #e74c3c; font-weight: bold;">{{ monthly_stats.total_distance | round(1) }}</div>
            <div style="color: #6c757d;">Kilometers</div>
        </div>
        <div style="text-align: center; padding: 1rem; background: #fffbf0; border-radius: 8px;">
            <div style="font-size: 2rem; color: #f39c12; font-weight: bold;">{{ monthly_stats.fitness_completed }}</div>
            <div style="color: #6c757d;">Completed</div>
        </div>
    </div>
    {% endif %}
</div>


{% else %}
<!-- All Users dashboard -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
        <div>
            <h2 style="margin: 0;">📊 Progress Tracker Dashboard</h2>
            <p style="margin: 0; color: #6c757d;">Track progress across all areas</p>
        </div>
    </div>
    
    <!-- Quick Action Buttons -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
        <a href="/web/reading/add" class="btn btn-primary" style="text-decoration: none; text-align: center; padding: 1rem;">📚 Add Reading</a>
        <a href="/web/drawing/add" class="btn btn-primary" style="text-decoration: none; text-align: center; padding: 1rem;">🎨 Add Drawing</a>
        <a href="/web/fitness/add" class="btn btn-primary" style="text-decoration: none; text-align: center; padding: 1rem;">💪 Add Fitness</a>
        <a href="/web/journal/add" class="btn btn-primary" style="text-decoration: none; text-align: center; padding: 1rem;">📝 Add Journal</a>
    </div>
</div>
{% endif %}

{% if selected_user %}
<!-- Historical Charts -->
<div class="card" style="margin-bottom: var(--spacing-lg);">
    <h3>📈 Progress Over Time (Last 6 Months)</h3>
    {% if selected_user.name == "simon" %}
    <div class="two-column">
        <div>
            <h4 style="margin-bottom: 1rem;">📚 Books Completed</h4>
            <div id="readingChart" style="height: 200px; position: relative;"></div>
        </div>
        <div>
            <h4 style="margin-bottom: 1rem;">🎨 Artworks Finished</h4>
            <div id="drawingChart" style="height: 200px; position: relative;"></div>
        </div>
    </div>
    {% else %}
    <div>
        <h4 style="margin-bottom: 1rem;">💪 Fitness Activities Completed</h4>
        <div id="fitnessChart" style="height: 200px; position: relative;"></div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="two-column">
    <div>
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">📚 Recent Reading</h3>
                {% if selected_user %}
                <a href="/web/reading?user_id={{ selected_user.id }}" class="btn btn-outline btn-sm">View All →</a>
                {% else %}
                <a href="/web/reading" class="btn btn-outline btn-sm">View All →</a>
                {% endif %}
            </div>
            {% if recent_reading %}
                {% for entry in recent_reading %}
                <div class="entry-card clickable-entry" onclick="window.location.href='/web/reading/edit/{{ entry.id }}'" style="cursor: pointer;">
                    <h4 class="entry-title">{{ entry.title }}</h4>
                    {% if entry.author %}<p><strong>By:</strong> {{ entry.author }}</p>{% endif %}
                    <div class="entry-meta">
                        <span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span>
                        {% if entry.length_pages %}
                        <span>• {{ entry.length_pages }} pages</span>
                        {% endif %}
                        {% if entry.started_date %}
                        <span>• Started {{ entry.started_date.strftime('%b %d, %Y') }}</span>
                        {% endif %}
                        {% if not selected_user %}
                        {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                        {% if user %}
                        <span>• {{ user.display_name }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--gray-500);">
                    <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">📚</div>
                    <p>No reading entries yet.</p>
                </div>
            {% endif %}
        </div>
        
        {% if recent_fitness or not selected_user or selected_user.name != "simon" %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">💪 Recent Fitness</h3>
                {% if selected_user %}
                <a href="/web/fitness?user_id={{ selected_user.id }}" class="btn btn-outline btn-sm">View All →</a>
                {% else %}
                <a href="/web/fitness" class="btn btn-outline btn-sm">View All →</a>
                {% endif %}
            </div>
            {% if recent_fitness %}
                {% for entry in recent_fitness %}
                <div class="entry-card clickable-entry" onclick="window.location.href='/web/fitness/edit/{{ entry.id }}'" style="cursor: pointer;">
                    <h4 class="entry-title">{{ entry.title }}</h4>
                    {% if entry.activity_type %}<p><strong>Type:</strong> {{ entry.activity_type | title }}</p>{% endif %}
                    <div class="entry-meta">
                        <span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span>
                        {% if entry.duration_minutes %}
                        <span>• {{ entry.duration_minutes }} min</span>
                        {% endif %}
                        {% if not selected_user %}
                        {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                        {% if user %}
                        <span>• {{ user.display_name }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--gray-500);">
                    <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">💪</div>
                    <p>No fitness entries yet.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    
    <div>
        {% if recent_drawing or not selected_user or selected_user.name == "simon" %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">🎨 Recent Drawing</h3>
                {% if selected_user %}
                <a href="/web/drawing?user_id={{ selected_user.id }}" class="btn btn-outline btn-sm">View All →</a>
                {% else %}
                <a href="/web/drawing" class="btn btn-outline btn-sm">View All →</a>
                {% endif %}
            </div>
            {% if recent_drawing %}
                {% for entry in recent_drawing %}
                <div class="entry-card clickable-entry{% if entry.image_url %} has-image{% endif %}" onclick="window.location.href='/web/drawing/edit/{{ entry.id }}'" style="cursor: pointer;">
                    {% if entry.image_url %}
                    <div style="flex-shrink: 0;">
                        <img src="{{ entry.image_url }}" alt="{{ entry.title }}" class="table-thumbnail" onclick="event.stopPropagation(); openImageModal(this.src)" style="width: 80px; height: 60px;">
                    </div>
                    {% endif %}
                    <div style="flex: 1;">
                        <h4 class="entry-title">{{ entry.title }}</h4>
                        {% if entry.subject %}<p><strong>Subject:</strong> {{ entry.subject }}</p>{% endif %}
                        <div class="entry-meta">
                            <span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span>
                            {% if entry.duration_hours %}
                            <span>• {{ entry.duration_hours }}h</span>
                            {% endif %}
                            {% if not selected_user %}
                            {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                            {% if user %}
                            <span>• {{ user.display_name }}</span>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--gray-500);">
                    <div style="font-size: 2rem; margin-bottom: var(--spacing-sm);">🎨</div>
                    <p>No drawing entries yet.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% if selected_user %}
<script>
// Simple chart rendering function
function renderChart(containerId, data, color) {
    const container = document.getElementById(containerId);
    if (!container || !data || data.length === 0) {
        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999;">No data available</div>';
        return;
    }
    
    const maxValue = Math.max(...data.map(d => d.count), 1);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    // Generate last 6 months
    const now = new Date();
    const chartData = [];
    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const monthName = months[date.getMonth()];
        
        const found = data.find(d => d.year === year && d.month === month);
        chartData.push({
            label: monthName,
            count: found ? found.count : 0
        });
    }
    
    let html = '<div style="display: flex; align-items: end; justify-content: space-around; height: 100%; padding: 10px;">';
    
    chartData.forEach(item => {
        const height = maxValue > 0 ? (item.count / maxValue) * 140 : 0;
        html += `
            <div style="display: flex; flex-direction: column; align-items: center; flex: 1; margin: 0 2px;">
                <div style="background: ${color}; width: 100%; max-width: 30px; height: ${height}px; border-radius: 3px 3px 0 0; margin-bottom: 5px; display: flex; align-items: end; justify-content: center; color: white; font-size: 10px; font-weight: bold;">
                    ${item.count > 0 ? item.count : ''}
                </div>
                <div style="font-size: 11px; color: #666;">${item.label}</div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Chart data from backend
{% if selected_user and selected_user.name == "simon" %}
var readingData = {{ reading_history | tojson if reading_history else '[]' }};
var drawingData = {{ drawing_history | tojson if drawing_history else '[]' }};
renderChart('readingChart', readingData, '#667eea');
renderChart('drawingChart', drawingData, '#e74c3c');
{% elif selected_user %}
var fitnessData = {{ fitness_history | tojson if fitness_history else '[]' }};
renderChart('fitnessChart', fitnessData, '#28a745');
{% endif %}

// Image modal handling for drawing thumbnails
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// Escape key to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endif %}

<!-- Image Modal -->
<div id="imageModal" class="image-modal" style="display: none;" onclick="closeImageModal()">
    <button class="close-btn" onclick="closeImageModal()">&times;</button>
    <img id="modalImage" src="" alt="">
</div>

{% endblock %}