{% extends "base.html" %}

{% block content %}
{% if not users %}
<div class="alert alert-info">
    <span aria-hidden="true">â„¹ï¸</span>
    <span>No users found. Create users via the API first.</span>
</div>
{% endif %}

{% if selected_user %}
<!-- User-specific dashboard -->
<div class="card">
    <div class="user-profile">
        <div class="user-avatar" aria-hidden="true">
            {% if selected_user.name == "simon" %}ğŸ§’{% else %}ğŸ‘¨{% endif %}
        </div>
        <div class="user-info">
            <h2>{{ selected_user.display_name }}'s Dashboard</h2>
            <p>
                {% if selected_user.name == "simon" %}
                    Reading & Drawing Progress
                {% else %}
                    Fitness & Health Tracking
                {% endif %}
            </p>
        </div>
        <a href="/web" class="back-link" aria-label="View all users">&larr; All Users</a>
    </div>

    <!-- Quick Actions for Selected User -->
    <div class="quick-actions">
        {% if selected_user.name == "simon" %}
        <a href="/web/reading/add?user_id={{ selected_user.id }}" class="btn"><span aria-hidden="true">ğŸ“š</span> Add Book</a>
        <a href="/web/drawing/add?user_id={{ selected_user.id }}" class="btn"><span aria-hidden="true">ğŸ¨</span> Add Art</a>
        <a href="/web/journal/add?user_id={{ selected_user.id }}" class="btn"><span aria-hidden="true">ğŸ“</span> Add Journal</a>
        {% else %}
        <a href="/web/fitness/add?user_id={{ selected_user.id }}" class="btn"><span aria-hidden="true">ğŸ’ª</span> Add Workout</a>
        <a href="/web/reading/add?user_id={{ selected_user.id }}" class="btn"><span aria-hidden="true">ğŸ“š</span> Add Book</a>
        <a href="/web/journal/add?user_id={{ selected_user.id }}" class="btn"><span aria-hidden="true">ğŸ“</span> Add Journal</a>
        {% endif %}
    </div>
</div>

<!-- Monthly Stats -->
<div class="card">
    <h3><span aria-hidden="true">ğŸ“Š</span> This Month's Progress</h3>

    {% if selected_user.name == "simon" %}
    <div class="stats-grid" style="margin-top:var(--sp-4)">
        <div class="stat-card">
            <div class="stat-number">{{ monthly_stats.reading_count }}</div>
            <div class="stat-label">Books Started</div>
            <div class="stat-sublabel">{{ monthly_stats.reading_completed }} completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color:var(--error)">{{ monthly_stats.drawing_count }}</div>
            <div class="stat-label">Art Projects</div>
            <div class="stat-sublabel">{{ monthly_stats.total_drawing_hours | round(1) }}h total</div>
        </div>
    </div>
    {% else %}
    <div class="stats-grid" style="margin-top:var(--sp-4)">
        <div class="stat-card">
            <div class="stat-number" style="color:var(--success)">{{ monthly_stats.fitness_count }}</div>
            <div class="stat-label">Activities</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ (monthly_stats.total_minutes / 60) | round(1) }}</div>
            <div class="stat-label">Hours</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color:var(--error)">{{ monthly_stats.total_distance | round(1) }}</div>
            <div class="stat-label">Kilometers</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" style="color:var(--warning)">{{ monthly_stats.fitness_completed }}</div>
            <div class="stat-label">Completed</div>
        </div>
    </div>
    {% endif %}
</div>

{% else %}
<!-- All Users dashboard -->
<div class="card">
    <h2><span aria-hidden="true">ğŸ“Š</span> Progress Tracker Dashboard</h2>
    <p class="text-muted">Track progress across all areas</p>

    <div class="quick-actions">
        <a href="/web/reading/add" class="btn"><span aria-hidden="true">ğŸ“š</span> Add Reading</a>
        <a href="/web/drawing/add" class="btn"><span aria-hidden="true">ğŸ¨</span> Add Drawing</a>
        <a href="/web/fitness/add" class="btn"><span aria-hidden="true">ğŸ’ª</span> Add Fitness</a>
        <a href="/web/journal/add" class="btn"><span aria-hidden="true">ğŸ“</span> Add Journal</a>
    </div>
</div>
{% endif %}

{% if selected_user %}
<!-- Historical Charts -->
<div class="card">
    <h3><span aria-hidden="true">ğŸ“ˆ</span> Progress Over Time (Last 6 Months)</h3>
    {% if selected_user.name == "simon" %}
    <div class="two-column" style="margin-top:var(--sp-4)">
        <div>
            <h4><span aria-hidden="true">ğŸ“š</span> Books Completed</h4>
            <div id="readingChart" class="chart-container"></div>
        </div>
        <div>
            <h4><span aria-hidden="true">ğŸ¨</span> Artworks Finished</h4>
            <div id="drawingChart" class="chart-container"></div>
        </div>
    </div>
    {% else %}
    <div style="margin-top:var(--sp-4)">
        <h4><span aria-hidden="true">ğŸ’ª</span> Fitness Activities Completed</h4>
        <div id="fitnessChart" class="chart-container"></div>
    </div>
    {% endif %}
</div>
{% endif %}

<div class="two-column">
    <div>
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><span aria-hidden="true">ğŸ“š</span> Recent Reading</h3>
                {% if selected_user %}
                <a href="/web/reading?user_id={{ selected_user.id }}" class="btn btn-outline btn-sm">View All &rarr;</a>
                {% else %}
                <a href="/web/reading" class="btn btn-outline btn-sm">View All &rarr;</a>
                {% endif %}
            </div>
            {% if recent_reading %}
                {% for entry in recent_reading %}
                <a href="/web/reading/edit/{{ entry.id }}" class="entry-card clickable-entry" style="display:block;text-decoration:none;color:inherit">
                    <div class="entry-title">{{ entry.title }}</div>
                    {% if entry.author %}<p style="padding:0 var(--sp-4);margin:0;color:var(--text-secondary)"><strong>By:</strong> {{ entry.author }}</p>{% endif %}
                    <div class="entry-meta" style="padding:var(--sp-2) var(--sp-4) var(--sp-3)">
                        <span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span>
                        {% if entry.length_pages %}
                        <span>&bull; {{ entry.length_pages }} pages</span>
                        {% endif %}
                        {% if entry.started_date %}
                        <span>&bull; Started {{ entry.started_date.strftime('%b %d, %Y') }}</span>
                        {% endif %}
                        {% if not selected_user %}
                        {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                        {% if user %}
                        <span>&bull; {{ user.display_name }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div aria-hidden="true" style="font-size:2rem;margin-bottom:var(--sp-3)">ğŸ“š</div>
                    <p>No reading entries yet.</p>
                </div>
            {% endif %}
        </div>

        {% if recent_fitness or not selected_user or selected_user.name != "simon" %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><span aria-hidden="true">ğŸ’ª</span> Recent Fitness</h3>
                {% if selected_user %}
                <a href="/web/fitness?user_id={{ selected_user.id }}" class="btn btn-outline btn-sm">View All &rarr;</a>
                {% else %}
                <a href="/web/fitness" class="btn btn-outline btn-sm">View All &rarr;</a>
                {% endif %}
            </div>
            {% if recent_fitness %}
                {% for entry in recent_fitness %}
                <a href="/web/fitness/edit/{{ entry.id }}" class="entry-card clickable-entry" style="display:block;text-decoration:none;color:inherit">
                    <div class="entry-title">{{ entry.title }}</div>
                    {% if entry.activity_type %}<p style="padding:0 var(--sp-4);margin:0;color:var(--text-secondary)"><strong>Type:</strong> {{ entry.activity_type | title }}</p>{% endif %}
                    <div class="entry-meta" style="padding:var(--sp-2) var(--sp-4) var(--sp-3)">
                        <span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span>
                        {% if entry.duration_minutes %}
                        <span>&bull; {{ entry.duration_minutes }} min</span>
                        {% endif %}
                        {% if not selected_user %}
                        {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                        {% if user %}
                        <span>&bull; {{ user.display_name }}</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div aria-hidden="true" style="font-size:2rem;margin-bottom:var(--sp-3)">ğŸ’ª</div>
                    <p>No fitness entries yet.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <div>
        {% if recent_drawing or not selected_user or selected_user.name == "simon" %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title"><span aria-hidden="true">ğŸ¨</span> Recent Drawing</h3>
                {% if selected_user %}
                <a href="/web/drawing?user_id={{ selected_user.id }}" class="btn btn-outline btn-sm">View All &rarr;</a>
                {% else %}
                <a href="/web/drawing" class="btn btn-outline btn-sm">View All &rarr;</a>
                {% endif %}
            </div>
            {% if recent_drawing %}
                {% for entry in recent_drawing %}
                <a href="/web/drawing/edit/{{ entry.id }}" class="entry-card clickable-entry{% if entry.image_url %} has-image{% endif %}" style="display:flex;text-decoration:none;color:inherit">
                    {% if entry.image_url %}
                    <div style="flex-shrink:0;padding:var(--sp-3)">
                        <img src="{{ entry.image_url }}" alt="Drawing: {{ entry.title }}" class="table-thumbnail" onclick="event.preventDefault();event.stopPropagation();openImageModal(this.src,this.alt)">
                    </div>
                    {% endif %}
                    <div style="flex:1">
                        <div class="entry-title">{{ entry.title }}</div>
                        {% if entry.subject %}<p style="padding:0 var(--sp-4);margin:0;color:var(--text-secondary)"><strong>Subject:</strong> {{ entry.subject }}</p>{% endif %}
                        <div class="entry-meta" style="padding:var(--sp-2) var(--sp-4) var(--sp-3)">
                            <span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span>
                            {% if entry.duration_hours %}
                            <span>&bull; {{ entry.duration_hours }}h</span>
                            {% endif %}
                            {% if not selected_user %}
                            {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                            {% if user %}
                            <span>&bull; {{ user.display_name }}</span>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div aria-hidden="true" style="font-size:2rem;margin-bottom:var(--sp-3)">ğŸ¨</div>
                    <p>No drawing entries yet.</p>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>

{% if selected_user %}
<script>
function renderChart(containerId, data, color) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (!data || data.length === 0) {
        container.innerHTML = '<div class="chart-empty">No data available</div>';
        return;
    }

    const maxValue = Math.max(...data.map(d => d.count), 1);
    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const now = new Date();
    const chartData = [];

    for (let i = 5; i >= 0; i--) {
        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const found = data.find(d => d.year === year && d.month === month);
        chartData.push({ label: months[date.getMonth()], count: found ? found.count : 0 });
    }

    let html = '<div class="chart-bars">';
    chartData.forEach(item => {
        const height = maxValue > 0 ? (item.count / maxValue) * 140 : 0;
        html += '<div class="chart-bar-group">' +
            '<div class="chart-bar" style="background:' + color + ';height:' + height + 'px">' +
            (item.count > 0 ? item.count : '') +
            '</div>' +
            '<div class="chart-bar-label">' + item.label + '</div>' +
            '</div>';
    });
    html += '</div>';
    container.innerHTML = html;
}

{% if selected_user and selected_user.name == "simon" %}
renderChart('readingChart', {{ reading_history | tojson if reading_history else '[]' }}, 'var(--primary)');
renderChart('drawingChart', {{ drawing_history | tojson if drawing_history else '[]' }}, 'var(--error)');
{% elif selected_user %}
renderChart('fitnessChart', {{ fitness_history | tojson if fitness_history else '[]' }}, 'var(--success)');
{% endif %}
</script>
{% endif %}

<!-- Image Modal -->
<div id="imageModal" class="image-modal" style="display:none" onclick="closeImageModal()" role="dialog" aria-modal="true" aria-label="Image viewer" tabindex="-1" aria-hidden="true">
    <button class="close-btn" onclick="closeImageModal()" aria-label="Close image viewer">&times;</button>
    <img id="modalImage" src="" alt="Full size drawing">
</div>
{% endblock %}
