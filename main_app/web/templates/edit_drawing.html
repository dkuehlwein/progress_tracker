{% extends "base.html" %}

{% block title %}Edit Drawing Entry - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <a href="/web/drawing" style="color: #667eea; text-decoration: none; font-size: 1.5rem;">‚Üê</a>
            <h2 class="card-title">üñåÔ∏è Edit Drawing Entry</h2>
        </div>
    </div>
</div>

<div class="card">
    <form action="/web/drawing/edit/{{ entry.id }}" method="POST" enctype="multipart/form-data">
        <div class="form-section">
            <div class="form-section-title">üìù Basic Information</div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="user_id" class="form-label required">User</label>
                    <select name="user_id" id="user_id" class="form-select" required>
                        {% for user in users %}
                        <option value="{{ user.id }}" {% if user.id == entry.user_id %}selected{% endif %}>{{ user.display_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="title" class="form-label required">Title</label>
                    <input type="text" name="title" id="title" class="form-input" required 
                           placeholder="Rainbow Snake Bead Design" value="{{ entry.title or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="subject" class="form-label">Subject</label>
                    <input type="text" name="subject" id="subject" class="form-input"
                           placeholder="Rainbow snake design using placement beads" value="{{ entry.subject or '' }}">
                </div>
                
                <div class="form-group">
                    <label for="medium" class="form-label">Medium</label>
                    <select name="medium" id="medium" class="form-select">
                        <option value="">Select medium</option>
                        {% for medium in drawing_mediums %}
                        <option value="{{ medium }}" {% if entry.medium and medium == entry.medium.value %}selected{% endif %}>{{ medium.replace('_', ' ').title() }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div class="form-section-title">üì∑ Image Upload</div>
            {% if entry.image_url %}
            <div class="current-image">
                <p><strong>Current image:</strong></p>
                <img src="{{ entry.image_url }}" class="image-preview" alt="Current drawing image">
                <p><small>Upload a new image to replace the current one, or leave empty to keep existing image.</small></p>
            </div>
            {% endif %}
            <div class="upload-area" id="uploadArea">
                <input type="file" id="imageFile" name="image" accept="image/*">
                <div class="upload-icon">üì∑</div>
                <div class="upload-text">Click to upload or drag & drop</div>
                <div class="upload-hint">PNG, JPG, GIF up to 10MB</div>
            </div>
            <div id="imagePreview" style="display: none;">
                <img id="previewImg" class="image-preview" alt="Preview">
                <button type="button" id="removeImage" class="btn btn-outline btn-sm">Remove Image</button>
            </div>
        </div>
        
        <div class="form-section optional">
            <div class="form-section-title toggle-section">
                <span class="toggle-icon">‚ñ∂</span>
                üìù Additional Details
                <span class="optional-badge">Optional</span>
            </div>
            <div class="collapsible-content">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="context" class="form-label">Context</label>
                        <textarea name="context" id="context" class="form-textarea"
                                  placeholder="Multi-day home project, working alongside almost-8-year-old peer (User-provided context)">{{ entry.context or '' }}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="duration_hours" class="form-label">Duration (hours)</label>
                        <input type="number" name="duration_hours" id="duration_hours" class="form-input"
                               step="0.1" placeholder="5.5" value="{{ entry.duration_hours or '' }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="status" class="form-label">Status</label>
                        <select name="status" id="status" class="form-select">
                            {% for status in drawing_statuses %}
                            <option value="{{ status }}" {% if status == entry.status.value %}selected{% endif %}>{{ status.replace('_', ' ').title() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="start_date" class="form-label">Start Date</label>
                        <input type="date" name="start_date" id="start_date" class="form-input"
                               value="{% if entry.start_date %}{{ entry.start_date.strftime('%Y-%m-%d') }}{% endif %}">
                    </div>
                    
                    <div class="form-group">
                        <label for="end_date" class="form-label">End Date</label>
                        <input type="date" name="end_date" id="end_date" class="form-input"
                               value="{% if entry.end_date %}{{ entry.end_date.strftime('%Y-%m-%d') }}{% endif %}">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="technical_notes" class="form-label">Technical Notes</label>
                        <textarea name="technical_notes" id="technical_notes" class="form-textarea"
                                  placeholder="AI analysis: Complex pattern matching, sophisticated technique development...">{{ entry.technical_notes or '' }}</textarea>
                    </div>

                    <div class="form-group full-width">
                        <label for="reference_link" class="form-label">Reference Link</label>
                        <input type="url" name="reference_link" id="reference_link" class="form-input"
                               placeholder="https://example.com/reference" value="{{ entry.reference_link or '' }}">
                    </div>
                </div>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-lg">Update Drawing Entry</button>
            <a href="/web/drawing" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
// Image upload handling
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('imageFile');
const previewDiv = document.getElementById('imagePreview');
const previewImg = document.getElementById('previewImg');
const removeBtn = document.getElementById('removeImage');

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('image/')) {
        fileInput.files = files;
        previewImage(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        previewImage(e.target.files[0]);
    }
});

removeBtn.addEventListener('click', () => {
    fileInput.value = '';
    previewDiv.style.display = 'none';
    uploadArea.style.display = 'block';
});

function previewImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewDiv.style.display = 'block';
        uploadArea.style.display = 'none';
    };
    reader.readAsDataURL(file);
}

// Collapsible sections
document.querySelectorAll('.toggle-section').forEach(section => {
    section.addEventListener('click', function() {
        const content = this.nextElementSibling;
        const icon = this.querySelector('.toggle-icon');
        
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            icon.textContent = '‚ñº';
        } else {
            content.style.display = 'none';
            icon.textContent = '‚ñ∂';
        }
    });
});
</script>
{% endblock %}