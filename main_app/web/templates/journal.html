{% extends "base.html" %}

{% block title %}Journal Entries - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><span aria-hidden="true">ğŸ“</span> Journal Entries</h3>
        <a href="/web/journal/add" class="btn"><span aria-hidden="true">âœï¸</span> Add Journal Entry</a>
    </div>

    <div class="filters" role="search" aria-label="Filter journal entries">
        <div class="form-group">
            <label for="userFilter">User</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="tagFilter">Tags</label>
            <select id="tagFilter">
                <option value="">All Tags</option>
                {% for tag in available_tags %}
                <option value="{{ tag }}" {% if tag_filter == tag %}selected{% endif %}>{{ tag.title() }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="searchFilter">Search</label>
            <input type="text" id="searchFilter" placeholder="Search entries...">
        </div>
    </div>

    <div class="entries-list">
        {% for entry in entries %}
        <div class="entry-card clickable-card" data-entry-id="{{ entry.id }}" onclick="toggleCard(this, event)">
            <div class="entry-header">
                <div class="entry-meta">
                    <div class="entry-main-line">
                        <span class="entry-date"><span aria-hidden="true">ğŸ“…</span> {{ entry.date.strftime('%B %d, %Y') }}</span>
                        {% if entry.title %}
                        <span class="entry-title-inline">{{ entry.title }}</span>
                        {% endif %}
                        <span class="entry-user">
                            {% for user in users %}
                            {% if user.id == entry.user_id %}
                                <span aria-hidden="true">{% if user.name == "simon" %}ğŸ§’{% else %}ğŸ‘¨{% endif %}</span> {{ user.display_name }}
                            {% endif %}
                            {% endfor %}
                        </span>
                        {% if entry.location %}
                        <span class="entry-location-inline"><span aria-hidden="true">ğŸ“</span> {{ entry.location }}</span>
                        {% endif %}
                    </div>
                    {% if entry.tags %}
                    <div class="entry-tags-line">
                        <span class="tags-symbol" aria-hidden="true">ğŸ·ï¸</span>
                        {% for tag in entry.tags.split(',') %}
                        <span class="tag tag-{{ tag.strip() }}">{{ tag.strip().title() }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                <div class="entry-actions">
                    <div class="action-buttons">
                        <a href="/web/journal/edit/{{ entry.id }}" class="btn btn-sm btn-outline" aria-label="Edit journal entry"><span aria-hidden="true">âœï¸</span></a>
                        <form method="post" action="/web/journal/delete/{{ entry.id }}" style="display:inline" onsubmit="return confirm('Delete this journal entry?')">
                            <button type="submit" class="btn btn-sm btn-delete" aria-label="Delete journal entry"><span aria-hidden="true">ğŸ—‘ï¸</span></button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="entry-preview">
                <div class="context-preview">{{ entry.context[:200]|markdown|safe }}...</div>
            </div>

            <div class="entry-details" style="display:none">
                <div class="detail-section">
                    <h5>Context & Observations</h5>
                    <div class="detail-content">{{ entry.context|markdown|safe }}</div>
                </div>
                {% if entry.parental_input %}
                <div class="detail-section">
                    <h5>Parental Input</h5>
                    <div class="detail-content">{{ entry.parental_input|markdown|safe }}</div>
                </div>
                {% endif %}
                {% if entry.ai_analysis %}
                <div class="detail-section">
                    <h5>Analysis</h5>
                    <div class="detail-content">{{ entry.ai_analysis|markdown|safe }}</div>
                </div>
                {% endif %}
                <div class="entry-metadata">
                    <small>
                        Created: {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}
                        {% if entry.updated_at %}| Updated: {{ entry.updated_at.strftime('%Y-%m-%d %H:%M') }}{% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if not entries %}
        <div class="empty-state">
            <h4>No journal entries found</h4>
            <p>Start tracking your development journey!</p>
            <a href="/web/journal/add" class="btn"><span aria-hidden="true">âœï¸</span> Add Your First Entry</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Server-side filtered (user, tag) + client-side search
document.getElementById('userFilter').addEventListener('change', function() {
    const url = new URL(window.location);
    if (this.value) { url.searchParams.set('user_id', this.value); } else { url.searchParams.delete('user_id'); }
    window.location = url;
});

document.getElementById('tagFilter').addEventListener('change', function() {
    const url = new URL(window.location);
    if (this.value) { url.searchParams.set('tag_filter', this.value); } else { url.searchParams.delete('tag_filter'); }
    window.location = url;
});

document.getElementById('searchFilter').addEventListener('input', function() {
    const term = this.value.toLowerCase();
    document.querySelectorAll('.entry-card').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(term) ? '' : 'none';
    });
});

function toggleCard(card, event) {
    if (event.target.closest('.btn-sm') || event.target.closest('a') || event.target.closest('form')) return;
    const details = card.querySelector('.entry-details');
    const preview = card.querySelector('.entry-preview');
    const isHidden = details.style.display === 'none';
    details.style.display = isHidden ? 'block' : 'none';
    preview.style.display = isHidden ? 'none' : 'block';
}
</script>
{% endblock %}
