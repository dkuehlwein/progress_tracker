{% extends "base.html" %}

{% block title %}Journal Entries - Progress Tracker{% endblock %}

{% block content %}
<!-- Journal Entries -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">📝 Journal Entries</h3>
        <a href="/web/journal/add" class="btn">✍️ Add Journal Entry</a>
    </div>
    
    <!-- Filters -->
    <div class="filters">
        <div class="form-group">
            <label for="userFilter">User:</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="tagFilter">Tags:</label>
            <select id="tagFilter">
                <option value="">All Tags</option>
                {% for tag in available_tags %}
                <option value="{{ tag }}" {% if tag_filter == tag %}selected{% endif %}>{{ tag.title() }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="searchFilter">Search:</label>
            <input type="text" id="searchFilter" class="form-control" placeholder="Search entries...">
        </div>
    </div>
    
    <!-- Journal Entries List -->
    <div class="entries-list">
        {% for entry in entries %}
        <div class="entry-card clickable-card" data-entry-id="{{ entry.id }}" onclick="toggleCard(this)">
            <div class="entry-header">
                <div class="entry-meta">
                    <span class="entry-date">📅 {{ entry.date.strftime('%B %d, %Y') }}</span>
                    <span class="entry-user">
                        {% for user in users %}
                        {% if user.id == entry.user_id %}
                            {% if user.name == "simon" %}🧒{% else %}👨{% endif %} {{ user.display_name }}
                        {% endif %}
                        {% endfor %}
                    </span>
                </div>
                <div class="entry-actions">
                    <a href="/web/journal/edit/{{ entry.id }}" class="btn-sm">✏️ Edit</a>
                    <form method="post" action="/web/journal/delete/{{ entry.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this journal entry?')">
                        <button type="submit" class="btn-sm btn-danger">🗑️ Delete</button>
                    </form>
                </div>
            </div>
            
            <div class="entry-title">
                {% if entry.title %}
                    <h4>{{ entry.title }}</h4>
                {% else %}
                    <h4 class="untitled">Journal Entry</h4>
                {% endif %}
                {% if entry.location %}
                    <span class="entry-location">📍 {{ entry.location }}</span>
                {% endif %}
                {% if entry.tags %}
                    <div class="entry-tags">
                        {% for tag in entry.tags.split(',') %}
                            <span class="tag tag-{{ tag.strip() }}">{{ tag.strip().title() }}</span>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
            
            <div class="entry-preview">
                <div class="context-preview">
                    {{ entry.context[:200] }}...
                </div>
            </div>
            
            <div class="entry-details" style="display: none;">
                <div class="detail-section">
                    <h5>Context & Observations</h5>
                    <div class="detail-content">{{ entry.context|replace('\n', '<br>')|safe }}</div>
                </div>
                
                {% if entry.parental_input %}
                <div class="detail-section">
                    <h5>Parental Input</h5>
                    <div class="detail-content">{{ entry.parental_input|replace('\n', '<br>')|safe }}</div>
                </div>
                {% endif %}
                
                {% if entry.ai_analysis %}
                <div class="detail-section">
                    <h5>Analysis</h5>
                    <div class="detail-content">{{ entry.ai_analysis|replace('\n', '<br>')|safe }}</div>
                </div>
                {% endif %}
                
                <div class="entry-metadata">
                    <small>
                        Created: {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}
                        {% if entry.updated_at %}
                        | Updated: {{ entry.updated_at.strftime('%Y-%m-%d %H:%M') }}
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if not entries %}
        <div class="empty-state">
            <h4>No journal entries found</h4>
            <p>Start tracking your development journey!</p>
            <a href="/web/journal/add" class="btn">✍️ Add Your First Entry</a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Filter functionality
document.getElementById('userFilter').addEventListener('change', function() {
    const userId = this.value;
    const url = new URL(window.location);
    if (userId) {
        url.searchParams.set('user_id', userId);
    } else {
        url.searchParams.delete('user_id');
    }
    window.location = url;
});

document.getElementById('tagFilter').addEventListener('change', function() {
    const tag = this.value;
    const url = new URL(window.location);
    if (tag) {
        url.searchParams.set('tag_filter', tag);
    } else {
        url.searchParams.delete('tag_filter');
    }
    window.location = url;
});

// Search functionality
document.getElementById('searchFilter').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const entries = document.querySelectorAll('.entry-card');
    
    entries.forEach(entry => {
        const text = entry.textContent.toLowerCase();
        entry.style.display = text.includes(searchTerm) ? 'block' : 'none';
    });
});

// Card toggle functionality
function toggleCard(card) {
    // Don't toggle if clicking on buttons or links
    if (event.target.closest('.btn-sm') || event.target.closest('a')) {
        return;
    }
    
    const details = card.querySelector('.entry-details');
    const preview = card.querySelector('.entry-preview');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        preview.style.display = 'none';
    } else {
        details.style.display = 'none';
        preview.style.display = 'block';
    }
}
</script>
{% endblock %}