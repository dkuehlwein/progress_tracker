{% extends "base.html" %}

{% block title %}Reading Entries - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title">üìö Reading Entries</h2>
            <a href="/web/reading/add" class="btn">üìñ Add Reading Entry</a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üîç Filters</h3>
    </div>
    <div class="filters">
        <div class="form-group">
            <label for="userFilter">User:</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter">
                <option value="">All Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="IN_PROGRESS">In Progress</option>
                <option value="PAUSED">Paused</option>
                <option value="COMPLETED">Completed</option>
                <option value="ABANDONED">Abandoned</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="typeFilter">Type:</label>
            <select id="typeFilter">
                <option value="">All Types</option>
                <option value="PHYSICAL_BOOK">Physical Book</option>
                <option value="AUDIOBOOK">Audiobook</option>
                <option value="EBOOK">E-book</option>
                <option value="MAGAZINE">Magazine</option>
                <option value="COMIC">Comic</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="searchFilter">Search:</label>
            <input type="text" id="searchFilter" placeholder="Title, author, or notes...">
        </div>
    </div>
</div>

<!-- Entries Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üìö Entries</h3>
        <span class="status-badge status-info" id="entryCount">{{ entries|length }} entries</span>
    </div>
    {% if entries %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Author</th>
                        <th>User</th>
                        <th>Status</th>
                        <th>Type</th>
                        <th>Progress</th>
                        <th>Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesTableBody">
                    {% for entry in entries %}
                    <tr data-user-id="{{ entry.user_id }}" 
                        data-status="{{ entry.status.value }}" 
                        data-type="{{ entry.reading_type.value if entry.reading_type else '' }}"
                        data-search="{{ (entry.title + ' ' + (entry.author or '') + ' ' + (entry.notes or '') + ' ' + (entry.series_info or '')).lower() }}">
                        <td>
                            <strong>{{ entry.title }}</strong>
                            {% if entry.series_info %}
                            <br><small style="color: #6c757d;">{{ entry.series_info }}</small>
                            {% endif %}
                        </td>
                        <td>{{ entry.author or '-' }}</td>
                        <td>
                            {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                            {{ user.display_name if user else 'Unknown' }}
                        </td>
                        <td>
                            <span class="status-badge status-{{ entry.status.value.lower() }}">
                                {{ entry.status.value.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>
                            {% if entry.reading_type %}
                                {{ entry.reading_type.value.replace('_', ' ').title() }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.progress_fraction %}
                                {{ (entry.progress_fraction * 100) | round | int }}%
                            {% else %}
                                -
                            {% endif %}
                            {% if entry.length_pages %}
                                <br><small>{{ entry.length_pages }} pages</small>
                            {% endif %}
                        </td>
                        <td>{{ entry.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="/web/reading/edit/{{ entry.id }}" class="btn btn-sm btn-outline">‚úèÔ∏è Edit</a>
                                <form method="POST" action="/web/reading/delete/{{ entry.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this reading entry?')">
                                    <button type="submit" class="btn btn-sm btn-delete">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% if entry.notes or entry.pause_reason or entry.isbn %}
                    <tr class="details-row" style="display: none;" id="details-{{ entry.id }}">
                        <td colspan="8">
                            {% if entry.isbn %}
                            <p><strong>ISBN:</strong> {{ entry.isbn }}</p>
                            {% endif %}
                            {% if entry.notes %}
                            <p><strong>Notes:</strong> {{ entry.notes }}</p>
                            {% endif %}
                            {% if entry.pause_reason %}
                            <p><strong>Pause Reason:</strong> {{ entry.pause_reason }}</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: var(--spacing-xl); color: #6c757d;">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üìö</div>
            <p>No reading entries found. <a href="/web/reading/add">Add your first book!</a></p>
        </div>
    {% endif %}
</div>

<script>
// Filter functionality
function filterEntries() {
    const userFilter = document.getElementById('userFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#entriesTableBody tr:not(.details-row)');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const userId = row.dataset.userId;
        const status = row.dataset.status;
        const type = row.dataset.type;
        const searchText = row.dataset.search;
        
        const userMatch = !userFilter || userId === userFilter;
        const statusMatch = !statusFilter || status === statusFilter;
        const typeMatch = !typeFilter || type === typeFilter;
        const searchMatch = !searchFilter || searchText.includes(searchFilter);
        
        if (userMatch && statusMatch && typeMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Hide associated details row if it exists
            const detailsRow = document.getElementById('details-' + row.querySelector('form').action.split('/').pop());
            if (detailsRow) {
                detailsRow.style.display = 'none';
            }
        }
    });
    
    // Update entry count
    document.getElementById('entryCount').textContent = `${visibleCount} entries`;
}

// Add event listeners
document.getElementById('userFilter').addEventListener('change', filterEntries);
document.getElementById('statusFilter').addEventListener('change', filterEntries);
document.getElementById('typeFilter').addEventListener('change', filterEntries);
document.getElementById('searchFilter').addEventListener('input', filterEntries);

// Row click to toggle details
document.querySelectorAll('#entriesTableBody tr:not(.details-row)').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
        
        const entryId = this.querySelector('form').action.split('/').pop();
        const detailsRow = document.getElementById('details-' + entryId);
        if (detailsRow) {
            detailsRow.style.display = detailsRow.style.display === 'none' ? '' : 'none';
        }
    });
});
</script>
{% endblock %}