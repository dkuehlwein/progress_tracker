{% extends "base.html" %}

{% block title %}Reading Entries - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><span aria-hidden="true">ğŸ“š</span> Reading Entries</h3>
        <a href="/web/reading/add" class="btn"><span aria-hidden="true">ğŸ“–</span> Add Reading Entry</a>
    </div>

    <!-- Filters -->
    <div class="filters" role="search" aria-label="Filter reading entries">
        <div class="form-group">
            <label for="userFilter">User</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="paused">Paused</option>
                <option value="completed">Completed</option>
                <option value="abandoned">Abandoned</option>
            </select>
        </div>
        <div class="form-group">
            <label for="typeFilter">Type</label>
            <select id="typeFilter">
                <option value="">All Types</option>
                <option value="physical_book">Physical Book</option>
                <option value="audiobook">Audiobook</option>
                <option value="ebook">E-book</option>
                <option value="magazine">Magazine</option>
                <option value="comic">Comic</option>
            </select>
        </div>
        <div class="form-group">
            <label for="searchFilter">Search</label>
            <input type="text" id="searchFilter" placeholder="Title, author, or notes...">
        </div>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters" id="activeFilters" aria-live="polite">
        <div class="active-filters-title"><span aria-hidden="true">ğŸ”</span> Active Filters</div>
        <div class="filter-chips" id="filterChips"></div>
    </div>

    {% if entries %}
    <div class="table-responsive">
        <table class="data-table" aria-label="Reading entries">
            <thead>
                <tr>
                    <th class="sortable" data-col="0">Title</th>
                    <th class="sortable" data-col="1">Author</th>
                    <th class="sortable" data-col="2">User</th>
                    <th class="sortable" data-col="3">Status</th>
                    <th class="sortable" data-col="4">Type</th>
                    <th class="sortable" data-col="5">Length</th>
                    <th class="sortable" data-col="6">Started</th>
                    <th class="sortable" data-col="7">Ended</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="entriesTableBody">
                {% for entry in entries %}
                <tr data-user-id="{{ entry.user_id }}"
                    data-status="{{ entry.status.value }}"
                    data-type="{{ entry.reading_type.value if entry.reading_type else '' }}"
                    data-search="{{ (entry.title + ' ' + (entry.author or '') + ' ' + (entry.notes or '') + ' ' + (entry.series_info or '')).lower() }}">
                    <td>
                        <strong>{{ entry.title }}</strong>
                        {% if entry.series_info %}
                        <br><small class="text-muted">{{ entry.series_info }}</small>
                        {% endif %}
                    </td>
                    <td>{{ entry.author or '-' }}</td>
                    <td>
                        {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                        {{ user.display_name if user else 'Unknown' }}
                    </td>
                    <td><span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span></td>
                    <td>{% if entry.reading_type %}{{ entry.reading_type.value.replace('_', ' ').title() }}{% else %}-{% endif %}</td>
                    <td>
                        {% if entry.reading_type and entry.reading_type.value == 'audiobook' %}
                            {% if entry.length_duration %}
                                {% if entry.length_duration >= 60 %}{{ entry.length_duration // 60 }}h {{ entry.length_duration % 60 }}m{% else %}{{ entry.length_duration }} min{% endif %}
                            {% else %}-{% endif %}
                        {% else %}
                            {% if entry.length_pages %}{{ entry.length_pages }} pages{% else %}-{% endif %}
                        {% endif %}
                    </td>
                    <td>{% if entry.started_date %}{{ entry.started_date.strftime('%Y-%m-%d') }}{% else %}-{% endif %}</td>
                    <td>
                        {% if entry.status.value == 'completed' %}
                            {% if entry.completed_date %}{{ entry.completed_date.strftime('%Y-%m-%d') }}{% else %}<span aria-label="Completed">âœ…</span>{% endif %}
                        {% elif entry.status.value == 'paused' and entry.paused_date %}
                            {{ entry.paused_date.strftime('%Y-%m-%d') }} (paused)
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/web/reading/edit/{{ entry.id }}" class="btn btn-sm btn-outline" aria-label="Edit {{ entry.title }}"><span aria-hidden="true">âœï¸</span></a>
                            <form method="POST" action="/web/reading/delete/{{ entry.id }}" style="display:inline" onsubmit="return confirm('Delete &quot;{{ entry.title }}&quot;?')">
                                <button type="submit" class="btn btn-sm btn-delete" aria-label="Delete {{ entry.title }}"><span aria-hidden="true">ğŸ—‘ï¸</span></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% if entry.notes or entry.pause_reason or entry.isbn %}
                <tr class="details-row" style="display:none" id="details-{{ entry.id }}">
                    <td colspan="9">
                        {% if entry.isbn %}<p><strong>ISBN:</strong> {{ entry.isbn }}</p>{% endif %}
                        {% if entry.notes %}<p><strong>Notes:</strong> {{ entry.notes }}</p>{% endif %}
                        {% if entry.pause_reason %}<p><strong>Pause Reason:</strong> {{ entry.pause_reason }}</p>{% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="results-counter" aria-live="polite">
        <div>Showing <span class="results-count" id="entryCount">{{ entries|length }}</span> entries</div>
        <div class="results-actions">
            <button class="btn-filter-reset" id="clearFilters" style="display:none" type="button"><span aria-hidden="true">ğŸ—‘ï¸</span> Clear Filters</button>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <div aria-hidden="true" style="font-size:3rem;margin-bottom:var(--sp-3)">ğŸ“š</div>
        <h4>No reading entries yet</h4>
        <p>Start tracking your reading progress!</p>
        <a href="/web/reading/add" class="btn">Add your first book</a>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
const readingTable = new FilterableTable({
    filters: [
        { id: 'userFilter',   dataAttr: 'userId', label: 'User',   type: 'select' },
        { id: 'statusFilter', dataAttr: 'status', label: 'Status', type: 'select' },
        { id: 'typeFilter',   dataAttr: 'type',   label: 'Type',   type: 'select' },
        { id: 'searchFilter', dataAttr: 'search', label: 'Search', type: 'search' },
    ],
    tableBodyId: 'entriesTableBody',
    counterId: 'entryCount',
    activeFiltersId: 'activeFilters',
    filterChipsId: 'filterChips',
    clearButtonId: 'clearFilters',
    sortConfig: { dateColumns: [6, 7] },
});

// Wire up sortable headers and clear button
document.querySelectorAll('.data-table th.sortable').forEach(th => {
    th.addEventListener('click', () => readingTable.sort(parseInt(th.dataset.col)));
});
document.getElementById('clearFilters')?.addEventListener('click', () => readingTable.clearAll());
</script>
{% endblock %}
