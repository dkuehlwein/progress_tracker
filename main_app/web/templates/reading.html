{% extends "base.html" %}

{% block title %}Reading Entries - Progress Tracker{% endblock %}

{% block content %}
<!-- Reading Entries -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üìö Reading Entries</h3>
        <a href="/web/reading/add" class="btn">üìñ Add Reading Entry</a>
    </div>
    
    <!-- Filters -->
    <div class="filters">
        <div class="form-group">
            <label for="userFilter">User:</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="paused">Paused</option>
                <option value="completed">Completed</option>
                <option value="abandoned">Abandoned</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="typeFilter">Type:</label>
            <select id="typeFilter">
                <option value="">All Types</option>
                <option value="physical_book">Physical Book</option>
                <option value="audiobook">Audiobook</option>
                <option value="ebook">E-book</option>
                <option value="magazine">Magazine</option>
                <option value="comic">Comic</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="searchFilter">Search:</label>
            <input type="text" id="searchFilter" placeholder="Title, author, or notes...">
        </div>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters" id="activeFilters">
        <div class="active-filters-title">üîç Active Filters</div>
        <div class="filter-chips" id="filterChips"></div>
    </div>

    {% if entries %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable(0)" data-sort="title">Title</th>
                        <th class="sortable" onclick="sortTable(1)" data-sort="author">Author</th>
                        <th class="sortable" onclick="sortTable(2)" data-sort="user">User</th>
                        <th class="sortable" onclick="sortTable(3)" data-sort="status">Status</th>
                        <th class="sortable" onclick="sortTable(4)" data-sort="type">Type</th>
                        <th class="sortable" onclick="sortTable(5)" data-sort="length">Length</th>
                        <th class="sortable" onclick="sortTable(6)" data-sort="started">Started</th>
                        <th class="sortable" onclick="sortTable(7)" data-sort="ended">Ended</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesTableBody">
                    {% for entry in entries %}
                    <tr data-user-id="{{ entry.user_id }}" 
                        data-status="{{ entry.status.value }}" 
                        data-type="{{ entry.reading_type.value if entry.reading_type else '' }}"
                        data-search="{{ (entry.title + ' ' + (entry.author or '') + ' ' + (entry.notes or '') + ' ' + (entry.series_info or '')).lower() }}">
                        <td>
                            <strong>{{ entry.title }}</strong>
                            {% if entry.series_info %}
                            <br><small style="color: #6c757d;">{{ entry.series_info }}</small>
                            {% endif %}
                        </td>
                        <td>{{ entry.author or '-' }}</td>
                        <td>
                            {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                            {{ user.display_name if user else 'Unknown' }}
                        </td>
                        <td>
                            <span class="status-badge status-{{ entry.status.value.lower() }}">
                                {{ entry.status.value.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>
                            {% if entry.reading_type %}
                                {{ entry.reading_type.value.replace('_', ' ').title() }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.reading_type and entry.reading_type.value == 'audiobook' %}
                                {% if entry.length_duration %}
                                    {% if entry.length_duration >= 60 %}
                                        {{ entry.length_duration // 60 }}h {{ entry.length_duration % 60 }}m
                                    {% else %}
                                        {{ entry.length_duration }} minutes
                                    {% endif %}
                                {% else %}
                                    -
                                {% endif %}
                            {% else %}
                                {% if entry.length_pages %}
                                    {{ entry.length_pages }} pages
                                {% else %}
                                    -
                                {% endif %}
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.started_date %}
                                {{ entry.started_date.strftime('%Y-%m-%d') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.status.value == 'completed' %}
                                {% if entry.completed_date %}
                                    {{ entry.completed_date.strftime('%Y-%m-%d') }}
                                {% else %}
                                    ‚úÖ
                                {% endif %}
                            {% elif entry.status.value == 'paused' and entry.paused_date %}
                                {{ entry.paused_date.strftime('%Y-%m-%d') }} (paused)
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="/web/reading/edit/{{ entry.id }}" class="btn btn-sm btn-outline">‚úèÔ∏è</a>
                                <form method="POST" action="/web/reading/delete/{{ entry.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this reading entry?')">
                                    <button type="submit" class="btn btn-sm btn-delete">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% if entry.notes or entry.pause_reason or entry.isbn %}
                    <tr class="details-row" style="display: none;" id="details-{{ entry.id }}">
                        <td colspan="9">
                            {% if entry.isbn %}
                            <p><strong>ISBN:</strong> {{ entry.isbn }}</p>
                            {% endif %}
                            {% if entry.notes %}
                            <p><strong>Notes:</strong> {{ entry.notes }}</p>
                            {% endif %}
                            {% if entry.pause_reason %}
                            <p><strong>Pause Reason:</strong> {{ entry.pause_reason }}</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="results-counter">
            <div>
                Showing <span class="results-count" id="entryCount">{{ entries|length }}</span> entries
            </div>
            <div class="results-actions">
                <button class="btn-filter-reset" id="clearFilters" onclick="clearAllFilters()" style="display: none;">
                    üóëÔ∏è Clear Filters
                </button>
            </div>
        </div>
    {% else %}
        <div style="text-align: center; padding: var(--spacing-xl); color: #6c757d;">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üìö</div>
            <p>No reading entries found. <a href="/web/reading/add">Add your first book!</a></p>
        </div>
    {% endif %}
</div>

<script>
// Enhanced Filter and Table Functionality
let currentSort = { column: -1, direction: 'asc' };
let activeFilters = {};

// Filter functionality with visual enhancements
function filterEntries() {
    const userFilter = document.getElementById('userFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const typeFilter = document.getElementById('typeFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    // Store active filters
    activeFilters = {
        user: userFilter,
        status: statusFilter,
        type: typeFilter,
        search: searchFilter
    };
    
    const rows = document.querySelectorAll('#entriesTableBody tr:not(.details-row)');
    let visibleCount = 0;
    
    // Add loading state
    const table = document.querySelector('.table-responsive');
    table.classList.add('table-loading');
    
    setTimeout(() => {
        rows.forEach(row => {
            const userId = row.dataset.userId;
            const status = row.dataset.status;
            const type = row.dataset.type;
            const searchText = row.dataset.search;
            
            const userMatch = !userFilter || userId === userFilter;
            const statusMatch = !statusFilter || status === statusFilter;
            const typeMatch = !typeFilter || type === typeFilter;
            const searchMatch = !searchFilter || searchText.includes(searchFilter);
            
            if (userMatch && statusMatch && typeMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
                // Hide associated details row if it exists
                const detailsRow = document.getElementById('details-' + row.querySelector('form').action.split('/').pop());
                if (detailsRow) {
                    detailsRow.style.display = 'none';
                }
            }
        });
        
        // Update entry count
        document.getElementById('entryCount').textContent = visibleCount;
        
        // Update active filters display
        updateActiveFiltersDisplay();
        
        // Remove loading state
        table.classList.remove('table-loading');
    }, 300);
}

// Sort table functionality
function sortTable(columnIndex) {
    const table = document.getElementById('entriesTableBody');
    const rows = Array.from(table.querySelectorAll('tr:not(.details-row)'));
    const headers = document.querySelectorAll('.data-table th.sortable');
    
    // Update sort direction
    if (currentSort.column === columnIndex) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = columnIndex;
        currentSort.direction = 'asc';
    }
    
    // Update header classes
    headers.forEach((header, index) => {
        header.classList.remove('sort-asc', 'sort-desc');
        if (index === columnIndex) {
            header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    });
    
    // Sort rows
    rows.sort((a, b) => {
        let aVal = a.children[columnIndex].textContent.trim();
        let bVal = b.children[columnIndex].textContent.trim();
        
        // Handle different data types
        if (columnIndex === 6 || columnIndex === 7) { // Start Date or End Date columns
            // Handle dates, including special cases
            if (aVal === '‚úÖ' || aVal === '-') aVal = '';
            if (bVal === '‚úÖ' || bVal === '-') bVal = '';
            // Remove "(paused)" suffix for paused dates
            aVal = aVal.replace(' (paused)', '');
            bVal = bVal.replace(' (paused)', '');
            aVal = aVal ? new Date(aVal) : new Date(0);
            bVal = bVal ? new Date(bVal) : new Date(0);
        } else {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Reappend sorted rows
    rows.forEach(row => {
        table.appendChild(row);
        // Also move associated details row if it exists
        const detailsRow = document.getElementById('details-' + row.querySelector('form').action.split('/').pop());
        if (detailsRow) {
            table.appendChild(detailsRow);
        }
    });
}

// Update active filters display
function updateActiveFiltersDisplay() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const filterChipsDiv = document.getElementById('filterChips');
    const clearButton = document.getElementById('clearFilters');
    
    filterChipsDiv.innerHTML = '';
    let hasActiveFilters = false;
    
    // Create filter chips
    if (activeFilters.user) {
        const userSelect = document.getElementById('userFilter');
        const selectedOption = userSelect.options[userSelect.selectedIndex];
        createFilterChip('User', selectedOption.text, () => {
            document.getElementById('userFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    if (activeFilters.status) {
        createFilterChip('Status', activeFilters.status.replace('_', ' ').replace(/\w+/g, w => w[0].toUpperCase() + w.slice(1)), () => {
            document.getElementById('statusFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    if (activeFilters.type) {
        createFilterChip('Type', activeFilters.type.replace('_', ' ').replace(/\w+/g, w => w[0].toUpperCase() + w.slice(1)), () => {
            document.getElementById('typeFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    if (activeFilters.search) {
        createFilterChip('Search', `"${activeFilters.search}"`, () => {
            document.getElementById('searchFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    // Show/hide active filters and clear button
    if (hasActiveFilters) {
        activeFiltersDiv.classList.add('has-filters');
        clearButton.style.display = 'inline-flex';
    } else {
        activeFiltersDiv.classList.remove('has-filters');
        clearButton.style.display = 'none';
    }
}

// Create filter chip
function createFilterChip(label, value, onRemove) {
    const chip = document.createElement('div');
    chip.className = 'filter-chip';
    chip.innerHTML = `
        <span>${label}: ${value}</span>
        <button class="filter-chip-remove" onclick="event.stopPropagation();">&times;</button>
    `;
    
    chip.querySelector('.filter-chip-remove').addEventListener('click', onRemove);
    document.getElementById('filterChips').appendChild(chip);
}

// Clear all filters
function clearAllFilters() {
    document.getElementById('userFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('typeFilter').value = '';
    document.getElementById('searchFilter').value = '';
    filterEntries();
}

// Add event listeners
document.getElementById('userFilter').addEventListener('change', filterEntries);
document.getElementById('statusFilter').addEventListener('change', filterEntries);
document.getElementById('typeFilter').addEventListener('change', filterEntries);
document.getElementById('searchFilter').addEventListener('input', filterEntries);

// Row click to toggle details with enhanced UX
document.querySelectorAll('#entriesTableBody tr:not(.details-row)').forEach(row => {
    row.classList.add('expandable');
    row.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A') return;
        
        const entryId = this.querySelector('form').action.split('/').pop();
        const detailsRow = document.getElementById('details-' + entryId);
        if (detailsRow) {
            const isVisible = detailsRow.style.display !== 'none';
            detailsRow.style.display = isVisible ? 'none' : '';
            this.classList.toggle('expanded', !isVisible);
        }
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    filterEntries();
});
</script>
{% endblock %}