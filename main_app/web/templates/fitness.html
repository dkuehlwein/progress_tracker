{% extends "base.html" %}

{% block title %}Fitness Entries - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><span aria-hidden="true">ğŸ’ª</span> Fitness Entries</h3>
        <a href="/web/fitness/add" class="btn"><span aria-hidden="true">ğŸƒ</span> Add Fitness Entry</a>
    </div>

    <div class="filters" role="search" aria-label="Filter fitness entries">
        <div class="form-group">
            <label for="userFilter">User</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
                <option value="">All Statuses</option>
                {% for status in fitness_statuses %}
                <option value="{{ status }}">{{ status.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="typeFilter">Activity Type</label>
            <select id="typeFilter">
                <option value="">All Types</option>
                {% for type in fitness_types %}
                <option value="{{ type }}">{{ type.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="searchFilter">Search</label>
            <input type="text" id="searchFilter" placeholder="Title, description, or notes...">
        </div>
    </div>

    <div class="active-filters" id="activeFilters" aria-live="polite">
        <div class="active-filters-title"><span aria-hidden="true">ğŸ”</span> Active Filters</div>
        <div class="filter-chips" id="filterChips"></div>
    </div>

    {% if entries %}
    <div class="table-responsive">
        <table class="data-table" aria-label="Fitness entries">
            <thead>
                <tr>
                    <th class="sortable" data-col="0">Title</th>
                    <th class="sortable" data-col="1">User</th>
                    <th class="sortable" data-col="2">Status</th>
                    <th class="sortable" data-col="3">Type</th>
                    <th class="sortable" data-col="4">Duration</th>
                    <th class="sortable" data-col="5">Distance</th>
                    <th class="sortable" data-col="6">Intensity</th>
                    <th class="sortable" data-col="7">Added</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="entriesTableBody">
                {% for entry in entries %}
                <tr data-user-id="{{ entry.user_id }}"
                    data-status="{{ entry.status.value }}"
                    data-type="{{ entry.activity_type.value if entry.activity_type else '' }}"
                    data-search="{{ (entry.title + ' ' + (entry.description or '') + ' ' + (entry.notes or '') + ' ' + (entry.location or '')).lower() }}">
                    <td>
                        <strong>{{ entry.title }}</strong>
                        {% if entry.description %}<br><small class="text-muted">{{ entry.description }}</small>{% endif %}
                    </td>
                    <td>{% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}{{ user.display_name if user else 'Unknown' }}</td>
                    <td><span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span></td>
                    <td>{% if entry.activity_type %}{{ entry.activity_type.value.replace('_', ' ').title() }}{% else %}-{% endif %}</td>
                    <td>{% if entry.duration_minutes %}{{ entry.duration_minutes }} min{% else %}-{% endif %}</td>
                    <td>{% if entry.distance_km %}{{ entry.distance_km }} km{% else %}-{% endif %}</td>
                    <td>{% if entry.intensity_level %}{{ entry.intensity_level.title() }}{% else %}-{% endif %}</td>
                    <td>{{ entry.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <div class="action-buttons">
                            <a href="/web/fitness/edit/{{ entry.id }}" class="btn btn-sm btn-outline" aria-label="Edit {{ entry.title }}"><span aria-hidden="true">âœï¸</span></a>
                            <form method="POST" action="/web/fitness/delete/{{ entry.id }}" style="display:inline" onsubmit="return confirm('Delete &quot;{{ entry.title }}&quot;?')">
                                <button type="submit" class="btn btn-sm btn-delete" aria-label="Delete {{ entry.title }}"><span aria-hidden="true">ğŸ—‘ï¸</span></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% if entry.location or entry.notes %}
                <tr class="details-row" style="display:none" id="details-{{ entry.id }}">
                    <td colspan="9">
                        {% if entry.location %}<p><strong>Location:</strong> {{ entry.location }}</p>{% endif %}
                        {% if entry.notes %}<p><strong>Notes:</strong> {{ entry.notes }}</p>{% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="results-counter" aria-live="polite">
        <div>Showing <span class="results-count" id="entryCount">{{ entries|length }}</span> entries</div>
        <div class="results-actions">
            <button class="btn-filter-reset" id="clearFilters" style="display:none" type="button"><span aria-hidden="true">ğŸ—‘ï¸</span> Clear Filters</button>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <div aria-hidden="true" style="font-size:3rem;margin-bottom:var(--sp-3)">ğŸ’ª</div>
        <h4>No fitness entries yet</h4>
        <p>Start tracking your workouts!</p>
        <a href="/web/fitness/add" class="btn">Add your first activity</a>
    </div>
    {% endif %}
</div>

<script>
const fitnessTable = new FilterableTable({
    filters: [
        { id: 'userFilter',   dataAttr: 'userId', label: 'User',   type: 'select' },
        { id: 'statusFilter', dataAttr: 'status', label: 'Status', type: 'select' },
        { id: 'typeFilter',   dataAttr: 'type',   label: 'Type',   type: 'select' },
        { id: 'searchFilter', dataAttr: 'search', label: 'Search', type: 'search' },
    ],
    tableBodyId: 'entriesTableBody',
    counterId: 'entryCount',
    activeFiltersId: 'activeFilters',
    filterChipsId: 'filterChips',
    clearButtonId: 'clearFilters',
    sortConfig: { dateColumns: [7], numericColumns: [4, 5] },
});

document.querySelectorAll('.data-table th.sortable').forEach(th => {
    th.addEventListener('click', () => fitnessTable.sort(parseInt(th.dataset.col)));
});
document.getElementById('clearFilters')?.addEventListener('click', () => fitnessTable.clearAll());
</script>
{% endblock %}
