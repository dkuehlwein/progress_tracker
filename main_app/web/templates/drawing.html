{% extends "base.html" %}

{% block title %}Drawing Entries - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3 class="card-title"><span aria-hidden="true">ğŸ¨</span> Drawing Entries</h3>
        <a href="/web/drawing/add" class="btn"><span aria-hidden="true">ğŸ–Œï¸</span> Add Drawing Entry</a>
    </div>

    <div class="filters" role="search" aria-label="Filter drawing entries">
        <div class="form-group">
            <label for="userFilter">User</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="statusFilter">Status</label>
            <select id="statusFilter">
                <option value="">All Statuses</option>
                {% for status in drawing_statuses %}
                <option value="{{ status }}">{{ status.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="mediumFilter">Medium</label>
            <select id="mediumFilter">
                <option value="">All Mediums</option>
                {% for medium in drawing_mediums %}
                <option value="{{ medium }}">{{ medium.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="searchFilter">Search</label>
            <input type="text" id="searchFilter" placeholder="Title, subject, or notes...">
        </div>
    </div>

    <div class="active-filters" id="activeFilters" aria-live="polite">
        <div class="active-filters-title"><span aria-hidden="true">ğŸ”</span> Active Filters</div>
        <div class="filter-chips" id="filterChips"></div>
    </div>

    {% if entries %}
    <div class="table-responsive">
        <table class="data-table" aria-label="Drawing entries">
            <thead>
                <tr>
                    <th class="sortable" data-col="0">Title</th>
                    <th class="sortable" data-col="1">User</th>
                    <th class="sortable" data-col="2">Status</th>
                    <th class="sortable" data-col="3">Medium</th>
                    <th class="sortable" data-col="4">Duration</th>
                    <th>Image</th>
                    <th class="sortable" data-col="6">Dates</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="entriesTableBody">
                {% for entry in entries %}
                <tr data-user-id="{{ entry.user_id }}"
                    data-status="{{ entry.status.value }}"
                    data-medium="{{ entry.medium.value if entry.medium else '' }}"
                    data-search="{{ (entry.title + ' ' + (entry.subject or '') + ' ' + (entry.technical_notes or '') + ' ' + (entry.context or '')).lower() }}">
                    <td>
                        <strong>{{ entry.title }}</strong>
                        {% if entry.subject %}<br><small class="text-muted">{{ entry.subject }}</small>{% endif %}
                    </td>
                    <td>{% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}{{ user.display_name if user else 'Unknown' }}</td>
                    <td><span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span></td>
                    <td>{% if entry.medium %}{{ entry.medium.value.replace('_', ' ').title() }}{% else %}-{% endif %}</td>
                    <td>{% if entry.duration_hours %}{{ entry.duration_hours }}h{% else %}-{% endif %}</td>
                    <td>
                        {% if entry.image_url %}
                        <img src="{{ entry.image_url }}" alt="Drawing: {{ entry.title }}" class="table-thumbnail" onclick="openImageModal(this.src, this.alt)">
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        {% if entry.start_date and entry.end_date %}{{ entry.start_date.strftime('%Y-%m-%d') }} to {{ entry.end_date.strftime('%Y-%m-%d') }}
                        {% elif entry.start_date %}Started: {{ entry.start_date.strftime('%Y-%m-%d') }}
                        {% elif entry.end_date %}Ended: {{ entry.end_date.strftime('%Y-%m-%d') }}
                        {% else %}-{% endif %}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="/web/drawing/edit/{{ entry.id }}" class="btn btn-sm btn-outline" aria-label="Edit {{ entry.title }}"><span aria-hidden="true">âœï¸</span></a>
                            {% if entry.reference_link %}
                            <a href="{{ entry.reference_link }}" target="_blank" rel="noopener" class="btn btn-sm btn-outline" aria-label="Reference link for {{ entry.title }}"><span aria-hidden="true">ğŸ”—</span></a>
                            {% endif %}
                            <form method="POST" action="/web/drawing/delete/{{ entry.id }}" style="display:inline" onsubmit="return confirm('Delete &quot;{{ entry.title }}&quot;?')">
                                <button type="submit" class="btn btn-sm btn-delete" aria-label="Delete {{ entry.title }}"><span aria-hidden="true">ğŸ—‘ï¸</span></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% if entry.context or entry.technical_notes %}
                <tr class="details-row" style="display:none" id="details-{{ entry.id }}">
                    <td colspan="8">
                        {% if entry.context %}<p><strong>Context (User):</strong> {{ entry.context }}</p>{% endif %}
                        {% if entry.technical_notes %}
                        <p><strong>Technical Notes (AI Analysis):</strong></p>
                        <div class="markdown-content">{{ entry.technical_notes|markdown|safe }}</div>
                        {% endif %}
                    </td>
                </tr>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="results-counter" aria-live="polite">
        <div>Showing <span class="results-count" id="entryCount">{{ entries|length }}</span> entries</div>
        <div class="results-actions">
            <button class="btn-filter-reset" id="clearFilters" style="display:none" type="button"><span aria-hidden="true">ğŸ—‘ï¸</span> Clear Filters</button>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <div aria-hidden="true" style="font-size:3rem;margin-bottom:var(--sp-3)">ğŸ¨</div>
        <h4>No drawing entries yet</h4>
        <p>Start tracking your art projects!</p>
        <a href="/web/drawing/add" class="btn">Add your first project</a>
    </div>
    {% endif %}
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" style="display:none" onclick="closeImageModal()" role="dialog" aria-modal="true" aria-label="Image viewer" tabindex="-1" aria-hidden="true">
    <button class="close-btn" onclick="closeImageModal()" aria-label="Close image viewer">&times;</button>
    <img id="modalImage" src="" alt="Full size drawing">
</div>

{% endblock %}

{% block scripts %}
<script>
const drawingTable = new FilterableTable({
    filters: [
        { id: 'userFilter',   dataAttr: 'userId', label: 'User',   type: 'select' },
        { id: 'statusFilter', dataAttr: 'status', label: 'Status', type: 'select' },
        { id: 'mediumFilter', dataAttr: 'medium', label: 'Medium', type: 'select' },
        { id: 'searchFilter', dataAttr: 'search', label: 'Search', type: 'search' },
    ],
    tableBodyId: 'entriesTableBody',
    counterId: 'entryCount',
    activeFiltersId: 'activeFilters',
    filterChipsId: 'filterChips',
    clearButtonId: 'clearFilters',
    sortConfig: { dateColumns: [6], numericColumns: [4] },
});

document.querySelectorAll('.data-table th.sortable').forEach(th => {
    th.addEventListener('click', () => drawingTable.sort(parseInt(th.dataset.col)));
});
document.getElementById('clearFilters')?.addEventListener('click', () => drawingTable.clearAll());
</script>
{% endblock %}
