{% extends "base.html" %}

{% block title %}Drawing Entries - Progress Tracker{% endblock %}

{% block content %}
<!-- Drawing Entries -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">🎨 Drawing Entries</h3>
        <a href="/web/drawing/add" class="btn">🖌️ Add Drawing Entry</a>
    </div>
    
    <!-- Filters -->
    <div class="filters">
        <div class="form-group">
            <label for="userFilter">User:</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter">
                <option value="">All Statuses</option>
                {% for status in drawing_statuses %}
                <option value="{{ status }}">{{ status.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="mediumFilter">Medium:</label>
            <select id="mediumFilter">
                <option value="">All Mediums</option>
                {% for medium in drawing_mediums %}
                <option value="{{ medium }}">{{ medium.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="searchFilter">Search:</label>
            <input type="text" id="searchFilter" placeholder="Title, subject, or notes...">
        </div>
    </div>

    <!-- Active Filters Display -->
    <div class="active-filters" id="activeFilters">
        <div class="active-filters-title">🔍 Active Filters</div>
        <div class="filter-chips" id="filterChips"></div>
    </div>
    {% if entries %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable(0)" data-sort="title">Title</th>
                        <th class="sortable" onclick="sortTable(1)" data-sort="user">User</th>
                        <th class="sortable" onclick="sortTable(2)" data-sort="status">Status</th>
                        <th class="sortable" onclick="sortTable(3)" data-sort="medium">Medium</th>
                        <th class="sortable" onclick="sortTable(4)" data-sort="duration">Duration</th>
                        <th>Image</th>
                        <th class="sortable" onclick="sortTable(6)" data-sort="dates">Dates</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesTableBody">
                    {% for entry in entries %}
                    <tr data-user-id="{{ entry.user_id }}" 
                        data-status="{{ entry.status.value }}" 
                        data-medium="{{ entry.medium.value if entry.medium else '' }}"
                        data-search="{{ (entry.title + ' ' + (entry.subject or '') + ' ' + (entry.technical_notes or '') + ' ' + (entry.context or '')).lower() }}">
                        <td>
                            <strong>{{ entry.title }}</strong>
                            {% if entry.subject %}
                            <br><small style="color: #6c757d;">{{ entry.subject }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                            {{ user.display_name if user else 'Unknown' }}
                        </td>
                        <td>
                            <span class="status-badge status-{{ entry.status.value.lower() }}">
                                {{ entry.status.value.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>
                            {% if entry.medium %}
                                {{ entry.medium.value.replace('_', ' ').title() }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.duration_hours %}
                                {{ entry.duration_hours }}h
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.image_url %}
                                <img src="{{ entry.image_url }}" alt="{{ entry.title }}" class="table-thumbnail" onclick="openImageModal(this.src)">
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.start_date and entry.end_date %}
                                {{ entry.start_date.strftime('%Y-%m-%d') }} to {{ entry.end_date.strftime('%Y-%m-%d') }}
                            {% elif entry.start_date %}
                                Started: {{ entry.start_date.strftime('%Y-%m-%d') }}
                            {% elif entry.end_date %}
                                Ended: {{ entry.end_date.strftime('%Y-%m-%d') }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="/web/drawing/edit/{{ entry.id }}" class="btn btn-sm btn-outline">✏️</a>
                                {% if entry.reference_link %}
                                <a href="{{ entry.reference_link }}" target="_blank" class="btn btn-sm btn-outline" title="Reference Link">🔗</a>
                                {% endif %}
                                <form method="POST" action="/web/drawing/delete/{{ entry.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this drawing entry?')">
                                    <button type="submit" class="btn btn-sm btn-delete">🗑️</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% if entry.context or entry.technical_notes %}
                    <tr class="details-row" style="display: none;" id="details-{{ entry.id }}">
                        <td colspan="8">
                            {% if entry.context %}
                            <p><strong>Context (User):</strong> {{ entry.context }}</p>
                            {% endif %}
                            {% if entry.technical_notes %}
                            <p><strong>Technical Notes (AI Analysis):</strong> {{ entry.technical_notes }}</p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="results-counter">
            <div>
                Showing <span class="results-count" id="entryCount">{{ entries|length }}</span> entries
            </div>
            <div class="results-actions">
                <button class="btn-filter-reset" id="clearFilters" onclick="clearAllFilters()" style="display: none;">
                    🗑️ Clear Filters
                </button>
            </div>
        </div>
    {% else %}
        <div style="text-align: center; padding: var(--spacing-xl); color: #6c757d;">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">🎨</div>
            <p>No drawing entries found. <a href="/web/drawing/add">Add your first project!</a></p>
        </div>
    {% endif %}
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" style="display: none;" onclick="closeImageModal()">
    <button class="close-btn" onclick="closeImageModal()">&times;</button>
    <img id="modalImage" src="" alt="">
</div>

<script>
// Enhanced Filter and Table Functionality
let currentSort = { column: -1, direction: 'asc' };
let activeFilters = {};

// Filter functionality with visual enhancements
function filterEntries() {
    const userFilter = document.getElementById('userFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const mediumFilter = document.getElementById('mediumFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    // Store active filters
    activeFilters = {
        user: userFilter,
        status: statusFilter,
        medium: mediumFilter,
        search: searchFilter
    };
    
    const rows = document.querySelectorAll('#entriesTableBody tr:not(.details-row)');
    let visibleCount = 0;
    
    // Add loading state
    const table = document.querySelector('.table-responsive');
    table.classList.add('table-loading');
    
    setTimeout(() => {
        rows.forEach(row => {
            const userId = row.dataset.userId;
            const status = row.dataset.status;
            const medium = row.dataset.medium;
            const searchText = row.dataset.search;
            
            const userMatch = !userFilter || userId === userFilter;
            const statusMatch = !statusFilter || status === statusFilter;
            const mediumMatch = !mediumFilter || medium === mediumFilter;
            const searchMatch = !searchFilter || searchText.includes(searchFilter);
            
            if (userMatch && statusMatch && mediumMatch && searchMatch) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
                // Hide associated details row if it exists
                const detailsRow = document.getElementById('details-' + row.querySelector('form').action.split('/').pop());
                if (detailsRow) {
                    detailsRow.style.display = 'none';
                }
            }
        });
        
        // Update entry count
        document.getElementById('entryCount').textContent = visibleCount;
        
        // Update active filters display
        updateActiveFiltersDisplay();
        
        // Remove loading state
        table.classList.remove('table-loading');
    }, 300);
}

// Sort table functionality
function sortTable(columnIndex) {
    const table = document.getElementById('entriesTableBody');
    const rows = Array.from(table.querySelectorAll('tr:not(.details-row)'));
    const headers = document.querySelectorAll('.data-table th.sortable');
    
    // Update sort direction
    if (currentSort.column === columnIndex) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = columnIndex;
        currentSort.direction = 'asc';
    }
    
    // Update header classes
    headers.forEach((header, index) => {
        header.classList.remove('sort-asc', 'sort-desc');
        if (index === columnIndex) {
            header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    });
    
    // Sort rows
    rows.sort((a, b) => {
        let aVal = a.children[columnIndex].textContent.trim();
        let bVal = b.children[columnIndex].textContent.trim();
        
        // Handle different data types
        if (columnIndex === 6) { // Dates column
            // Extract first date for sorting (start date or single date)
            const aDate = aVal.match(/\d{4}-\d{2}-\d{2}/);
            const bDate = bVal.match(/\d{4}-\d{2}-\d{2}/);
            aVal = aDate ? new Date(aDate[0]) : new Date(0);
            bVal = bDate ? new Date(bDate[0]) : new Date(0);
        } else {
            aVal = aVal.toLowerCase();
            bVal = bVal.toLowerCase();
        }
        
        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    // Reappend sorted rows
    rows.forEach(row => {
        table.appendChild(row);
        // Also move associated details row if it exists
        const detailsRow = document.getElementById('details-' + row.querySelector('form').action.split('/').pop());
        if (detailsRow) {
            table.appendChild(detailsRow);
        }
    });
}

// Update active filters display
function updateActiveFiltersDisplay() {
    const activeFiltersDiv = document.getElementById('activeFilters');
    const filterChipsDiv = document.getElementById('filterChips');
    const clearButton = document.getElementById('clearFilters');
    
    filterChipsDiv.innerHTML = '';
    let hasActiveFilters = false;
    
    // Create filter chips
    if (activeFilters.user) {
        const userSelect = document.getElementById('userFilter');
        const selectedOption = userSelect.options[userSelect.selectedIndex];
        createFilterChip('User', selectedOption.text, () => {
            document.getElementById('userFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    if (activeFilters.status) {
        createFilterChip('Status', activeFilters.status.replace('_', ' ').replace(/\w+/g, w => w[0].toUpperCase() + w.slice(1)), () => {
            document.getElementById('statusFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    if (activeFilters.medium) {
        createFilterChip('Medium', activeFilters.medium.replace('_', ' ').replace(/\w+/g, w => w[0].toUpperCase() + w.slice(1)), () => {
            document.getElementById('mediumFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    if (activeFilters.search) {
        createFilterChip('Search', `"${activeFilters.search}"`, () => {
            document.getElementById('searchFilter').value = '';
            filterEntries();
        });
        hasActiveFilters = true;
    }
    
    // Show/hide active filters and clear button
    if (hasActiveFilters) {
        activeFiltersDiv.classList.add('has-filters');
        clearButton.style.display = 'inline-flex';
    } else {
        activeFiltersDiv.classList.remove('has-filters');
        clearButton.style.display = 'none';
    }
}

// Create filter chip
function createFilterChip(label, value, onRemove) {
    const chip = document.createElement('div');
    chip.className = 'filter-chip';
    chip.innerHTML = `
        <span>${label}: ${value}</span>
        <button class="filter-chip-remove" onclick="event.stopPropagation();">&times;</button>
    `;
    
    chip.querySelector('.filter-chip-remove').addEventListener('click', onRemove);
    document.getElementById('filterChips').appendChild(chip);
}

// Clear all filters
function clearAllFilters() {
    document.getElementById('userFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('mediumFilter').value = '';
    document.getElementById('searchFilter').value = '';
    filterEntries();
}

// Add event listeners
document.getElementById('userFilter').addEventListener('change', filterEntries);
document.getElementById('statusFilter').addEventListener('change', filterEntries);
document.getElementById('mediumFilter').addEventListener('change', filterEntries);
document.getElementById('searchFilter').addEventListener('input', filterEntries);

// Row click to toggle details with enhanced UX
document.querySelectorAll('#entriesTableBody tr:not(.details-row)').forEach(row => {
    row.classList.add('expandable');
    row.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'IMG') return;
        
        const entryId = this.querySelector('form').action.split('/').pop();
        const detailsRow = document.getElementById('details-' + entryId);
        if (detailsRow) {
            const isVisible = detailsRow.style.display !== 'none';
            detailsRow.style.display = isVisible ? 'none' : '';
            this.classList.toggle('expanded', !isVisible);
        }
    });
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    filterEntries();
});

// Image modal handling
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// Escape key to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}