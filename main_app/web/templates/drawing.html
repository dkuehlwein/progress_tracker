{% extends "base.html" %}

{% block title %}Drawing Entries - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 class="card-title">üé® Drawing Entries</h2>
            <a href="/web/drawing/add" class="btn">üñåÔ∏è Add Drawing Entry</a>
        </div>
    </div>
</div>

<!-- Filters -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üîç Filters</h3>
    </div>
    <div class="filters">
        <div class="form-group">
            <label for="userFilter">User:</label>
            <select id="userFilter">
                <option value="">All Users</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if selected_user_id == user.id %}selected{% endif %}>{{ user.display_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter">
                <option value="">All Statuses</option>
                {% for status in drawing_statuses %}
                <option value="{{ status }}">{{ status.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="mediumFilter">Medium:</label>
            <select id="mediumFilter">
                <option value="">All Mediums</option>
                {% for medium in drawing_mediums %}
                <option value="{{ medium }}">{{ medium.replace('_', ' ').title() }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="searchFilter">Search:</label>
            <input type="text" id="searchFilter" placeholder="Title, subject, or notes...">
        </div>
    </div>
</div>

<!-- Entries Table -->
<div class="card">
    <div class="card-header">
        <h3 class="card-title">üé® Entries</h3>
        <span class="status-badge status-info" id="entryCount">{{ entries|length }} entries</span>
    </div>
    {% if entries %}
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>User</th>
                        <th>Status</th>
                        <th>Medium</th>
                        <th>Duration</th>
                        <th>Image</th>
                        <th>Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="entriesTableBody">
                    {% for entry in entries %}
                    <tr data-user-id="{{ entry.user_id }}" 
                        data-status="{{ entry.status.value }}" 
                        data-medium="{{ entry.medium.value if entry.medium else '' }}"
                        data-search="{{ (entry.title + ' ' + (entry.subject or '') + ' ' + (entry.technical_notes or '') + ' ' + (entry.context or '')).lower() }}">
                        <td>
                            <strong>{{ entry.title }}</strong>
                            {% if entry.subject %}
                            <br><small style="color: #6c757d;">{{ entry.subject }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                            {{ user.display_name if user else 'Unknown' }}
                        </td>
                        <td>
                            <span class="status-badge status-{{ entry.status.value.lower() }}">
                                {{ entry.status.value.replace('_', ' ').title() }}
                            </span>
                        </td>
                        <td>
                            {% if entry.medium %}
                                {{ entry.medium.value.replace('_', ' ').title() }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.duration_hours %}
                                {{ entry.duration_hours }}h
                            {% else %}
                                -
                            {% endif %}
                            {% if entry.sessions_count %}
                                <br><small>{{ entry.sessions_count }} sessions</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if entry.image_url %}
                                <img src="{{ entry.image_url }}" alt="{{ entry.title }}" class="table-thumbnail" onclick="openImageModal(this.src)">
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>{{ entry.created_at.strftime('%Y-%m-%d') }}</td>
                        <td>
                            <div class="action-buttons">
                                <a href="/web/drawing/edit/{{ entry.id }}" class="btn btn-sm btn-outline">‚úèÔ∏è Edit</a>
                                <form method="POST" action="/web/drawing/delete/{{ entry.id }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this drawing entry?')">
                                    <button type="submit" class="btn btn-sm btn-delete">üóëÔ∏è</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% if entry.context or entry.technical_notes or entry.materials_count or entry.complexity_level %}
                    <tr class="details-row" style="display: none;" id="details-{{ entry.id }}">
                        <td colspan="8">
                            {% if entry.context %}
                            <p><strong>Context:</strong> {{ entry.context }}</p>
                            {% endif %}
                            {% if entry.materials_count %}
                            <p><strong>Materials:</strong> {{ entry.materials_count }} pieces</p>
                            {% endif %}
                            {% if entry.complexity_level %}
                            <p><strong>Complexity:</strong> {{ entry.complexity_level.title() }}</p>
                            {% endif %}
                            {% if entry.technical_notes %}
                            <p><strong>Technical Notes:</strong> {{ entry.technical_notes }}</p>
                            {% endif %}
                            {% if entry.reference_link %}
                            <p><strong>Reference:</strong> <a href="{{ entry.reference_link }}" target="_blank">{{ entry.reference_link }}</a></p>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div style="text-align: center; padding: var(--spacing-xl); color: #6c757d;">
            <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üé®</div>
            <p>No drawing entries found. <a href="/web/drawing/add">Add your first project!</a></p>
        </div>
    {% endif %}
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" style="display: none;" onclick="closeImageModal()">
    <button class="close-btn" onclick="closeImageModal()">&times;</button>
    <img id="modalImage" src="" alt="">
</div>

<script>
// Filter functionality
function filterEntries() {
    const userFilter = document.getElementById('userFilter').value;
    const statusFilter = document.getElementById('statusFilter').value;
    const mediumFilter = document.getElementById('mediumFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    const rows = document.querySelectorAll('#entriesTableBody tr:not(.details-row)');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const userId = row.dataset.userId;
        const status = row.dataset.status;
        const medium = row.dataset.medium;
        const searchText = row.dataset.search;
        
        const userMatch = !userFilter || userId === userFilter;
        const statusMatch = !statusFilter || status === statusFilter;
        const mediumMatch = !mediumFilter || medium === mediumFilter;
        const searchMatch = !searchFilter || searchText.includes(searchFilter);
        
        if (userMatch && statusMatch && mediumMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
            // Hide associated details row if it exists
            const detailsRow = document.getElementById('details-' + row.querySelector('form').action.split('/').pop());
            if (detailsRow) {
                detailsRow.style.display = 'none';
            }
        }
    });
    
    // Update entry count
    document.getElementById('entryCount').textContent = `${visibleCount} entries`;
}

// Add event listeners
document.getElementById('userFilter').addEventListener('change', filterEntries);
document.getElementById('statusFilter').addEventListener('change', filterEntries);
document.getElementById('mediumFilter').addEventListener('change', filterEntries);
document.getElementById('searchFilter').addEventListener('input', filterEntries);

// Row click to toggle details
document.querySelectorAll('#entriesTableBody tr:not(.details-row)').forEach(row => {
    row.style.cursor = 'pointer';
    row.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.tagName === 'IMG') return;
        
        const entryId = this.querySelector('form').action.split('/').pop();
        const detailsRow = document.getElementById('details-' + entryId);
        if (detailsRow) {
            detailsRow.style.display = detailsRow.style.display === 'none' ? '' : 'none';
        }
    });
});

// Image modal handling
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// Escape key to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}