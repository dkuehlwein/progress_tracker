{% extends "base.html" %}

{% block title %}Drawing Progress - Progress Tracker{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">üé® Drawing Progress</h2>
    </div>
</div>

<div class="two-column">
    <div>
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üñåÔ∏è Add Drawing Entry</h3>
            </div>
            <form action="/web/drawing/add" method="POST" enctype="multipart/form-data">
                <div class="form-section">
                    <div class="form-section-title">üìù Basic Information</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="user_id" class="form-label required">User</label>
                            <select name="user_id" id="user_id" class="form-select" required>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="title" class="form-label required">Title</label>
                            <input type="text" name="title" id="title" class="form-input" required 
                                   placeholder="Rainbow Snake Bead Design">
                        </div>
                        
                        <div class="form-group">
                            <label for="subject" class="form-label">Subject</label>
                            <input type="text" name="subject" id="subject" class="form-input"
                                   placeholder="Rainbow snake design using placement beads">
                        </div>
                        
                        <div class="form-group">
                            <label for="medium" class="form-label">Medium</label>
                            <select name="medium" id="medium" class="form-select">
                                <option value="">Select medium</option>
                                {% for medium in drawing_mediums %}
                                <option value="{{ medium }}">{{ medium.replace('_', ' ').title() }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="form-section-title">üì∑ Image Upload</div>
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="imageFile" name="image" accept="image/*">
                        <div class="upload-icon">üì∑</div>
                        <div class="upload-text">Click to upload or drag & drop</div>
                        <div class="upload-hint">PNG, JPG, GIF up to 10MB</div>
                    </div>
                    <div id="imagePreview" style="display: none;">
                        <img id="previewImg" class="image-preview" alt="Preview">
                        <button type="button" id="removeImage" class="btn btn-outline btn-sm">Remove Image</button>
                    </div>
                </div>
                
                <div class="form-section optional">
                    <div class="form-section-title toggle-section">
                        <span class="toggle-icon">‚ñ∂</span>
                        üìù Additional Details
                        <span class="optional-badge">Optional</span>
                    </div>
                    <div class="collapsible-content">
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label for="context" class="form-label">Context</label>
                                <textarea name="context" id="context" class="form-textarea"
                                          placeholder="Multi-day home project, working alongside almost-8-year-old peer"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label for="duration_hours" class="form-label">Duration (hours)</label>
                                <input type="number" name="duration_hours" id="duration_hours" class="form-input"
                                       step="0.1" placeholder="5.5">
                            </div>
                            
                            <div class="form-group">
                                <label for="sessions_count" class="form-label">Sessions</label>
                                <input type="number" name="sessions_count" id="sessions_count" class="form-input"
                                       placeholder="5">
                            </div>
                            
                            <div class="form-group">
                                <label for="materials_count" class="form-label">Materials Count</label>
                                <input type="number" name="materials_count" id="materials_count" class="form-input"
                                       placeholder="2000">
                            </div>
                            
                            <div class="form-group">
                                <label for="complexity_level" class="form-label">Complexity Level</label>
                                <select name="complexity_level" id="complexity_level" class="form-select">
                                    <option value="">Select level</option>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="status" class="form-label">Status</label>
                                <select name="status" id="status" class="form-select">
                                    {% for status in drawing_statuses %}
                                    <option value="{{ status }}">{{ status.replace('_', ' ').title() }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="form-group full-width">
                                <label for="technical_notes" class="form-label">Technical Notes</label>
                                <textarea name="technical_notes" id="technical_notes" class="form-textarea"
                                          placeholder="Complex pattern matching: Precise screen-to-grid translation..."></textarea>
                            </div>

                            <div class="form-group full-width">
                                <label for="reference_link" class="form-label">Reference Link</label>
                                <input type="url" name="reference_link" id="reference_link" class="form-input"
                                       placeholder="https://example.com/reference">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg">Add Drawing Entry</button>
            </form>
        </div>
    </div>
    
    <div>
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">üé® Drawing Entries</h3>
                <span class="status-badge status-info">{{ entries|length }} entries</span>
            </div>
            {% if entries %}
                {% for entry in entries %}
                <div class="entry-card">
                    <div class="entry-header">
                        <div>
                            <h4 class="entry-title">{{ entry.title }}</h4>
                            {% if entry.subject %}
                            <p><strong>Subject:</strong> {{ entry.subject }}</p>
                            {% endif %}
                            
                            <div class="entry-meta">
                                <span class="status-badge status-{{ entry.status.value.lower() }}">{{ entry.status.value.replace('_', ' ').title() }}</span>
                                
                                {% set user = users | selectattr('id', 'equalto', entry.user_id) | first %}
                                {% if user %}
                                <span>‚Ä¢ {{ user.display_name }}</span>
                                {% endif %}
                                
                                {% if entry.duration_hours %}
                                <span>‚Ä¢ {{ entry.duration_hours }}h</span>
                                {% endif %}
                                
                                {% if entry.sessions_count %}
                                <span>‚Ä¢ {{ entry.sessions_count }} sessions</span>
                                {% endif %}
                            </div>
                        </div>
                        <div class="entry-actions">
                            <a href="/web/drawing/edit/{{ entry.id }}" class="btn btn-outline btn-sm">‚úèÔ∏è Edit</a>
                            <form method="POST" action="/web/drawing/delete/{{ entry.id }}" style="display: inline; margin-left: var(--spacing-sm);" onsubmit="return confirm('Are you sure you want to delete this drawing entry?')">
                                <button type="submit" class="btn btn-delete btn-sm">üóëÔ∏è Delete</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Display image if available -->
                    {% if entry.image_url or entry.reference_link %}
                    <div class="image-gallery">
                        {% if entry.image_url %}
                        <div class="image-container">
                            <img src="{{ entry.image_url }}" alt="{{ entry.title }}" class="drawing-image" 
                                 onclick="openImageModal(this.src)">
                            <div class="image-overlay">Click to expand</div>
                        </div>
                        {% endif %}
                        {% if entry.reference_link %}
                        <div class="image-container">
                            <a href="{{ entry.reference_link }}" target="_blank" class="btn btn-secondary">
                                üîó View Reference Link
                            </a>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    {% if entry.medium or entry.context or entry.materials_count or entry.complexity_level or entry.technical_notes %}
                    <div class="entry-details" style="margin-top: var(--spacing-md);">
                        {% if entry.medium %}
                        <p><strong>Medium:</strong> {{ entry.medium.value.replace('_', ' ').title() }}</p>
                        {% endif %}
                        
                        {% if entry.context %}
                        <p><strong>Context:</strong> {{ entry.context }}</p>
                        {% endif %}
                        
                        {% if entry.materials_count %}
                        <p><strong>Materials:</strong> {{ entry.materials_count }} pieces</p>
                        {% endif %}
                        
                        {% if entry.complexity_level %}
                        <p><strong>Complexity:</strong> {{ entry.complexity_level.title() }}</p>
                        {% endif %}
                        
                        {% if entry.technical_notes %}
                        <p><strong>Technical Notes:</strong> {{ entry.technical_notes }}</p>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <small style="color: var(--gray-500); margin-top: var(--spacing-md); display: block;">
                        Added: {{ entry.created_at.strftime('%Y-%m-%d %H:%M') }}
                    </small>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: var(--spacing-xl); color: var(--gray-500);">
                    <div style="font-size: 3rem; margin-bottom: var(--spacing-md);">üé®</div>
                    <p>No drawing entries found. Add your first project above!</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal" style="display: none;" onclick="closeImageModal()">
    <button class="close-btn" onclick="closeImageModal()">&times;</button>
    <img id="modalImage" src="" alt="">
</div>

<script>
// Image upload handling
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('imageFile');
const previewDiv = document.getElementById('imagePreview');
const previewImg = document.getElementById('previewImg');
const removeBtn = document.getElementById('removeImage');

uploadArea.addEventListener('click', () => fileInput.click());
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0 && files[0].type.startsWith('image/')) {
        fileInput.files = files;
        previewImage(files[0]);
    }
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        previewImage(e.target.files[0]);
    }
});

removeBtn.addEventListener('click', () => {
    fileInput.value = '';
    previewDiv.style.display = 'none';
    uploadArea.style.display = 'block';
});

function previewImage(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        previewImg.src = e.target.result;
        previewDiv.style.display = 'block';
        uploadArea.style.display = 'none';
    };
    reader.readAsDataURL(file);
}

// Image modal handling
function openImageModal(src) {
    document.getElementById('modalImage').src = src;
    document.getElementById('imageModal').style.display = 'flex';
}

function closeImageModal() {
    document.getElementById('imageModal').style.display = 'none';
}

// Escape key to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        closeImageModal();
    }
});
</script>
{% endblock %}